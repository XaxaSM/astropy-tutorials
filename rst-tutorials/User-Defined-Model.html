<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="filterTutorials, filterModeling, filterFits, filterAstrostatistics, filterMatplotlib, filterModelFitting, filterErrorBars, filterScatterPlots" name="keywords" />
<meta content="filterTutorials," name="keywords" />

    <title>Modeling 2: Create a User Defined Model using astropy.modeling &#8212; astropy-tutorials v3.0.dev</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap_sandstone.css" />
    <link rel="stylesheet" type="text/css" href="../_static/astropy.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <script src="../_static/searchtools.js"></script>
    <script src="https://use.fontawesome.com/3168e95f94.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="shortcut icon" href="../_static/astropy_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript">
    jQuery(function() { Search.loadIndex("../searchindex.js"); });
  </script>
  
  <script type="text/javascript" id="searchindexloader"></script>
   

  </head><body>


<nav class="navbar navbar-expand-lg bg-navbar">
  <a class="navbar-brand" href="/" style="padding: 0px 5px;">
    <img src="../../_static/astropy_logo.png" onerror="this.onerror=null;this.src='../_static/astropy_logo.png';" style="height: 38px;">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarColor01">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item active">
        <a class="nav-link" href="http://www.astropy.org"/>Astropy<span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Modules</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0" action="../search.html" method="get">
      <div class="input-group-prepend">
          <button class="input-group-text" style="padding: 0.7rem"><i class="fa fa-search fa-fw"></i></button>
      </div>
      <input class="form-control mr-sm-3" name="q" type="text" placeholder="Search the universe" />
    </form>
  </div>
</nav>


<div class="container">
  <div class="row">

    
    
    

    
    <div class="col-md-3">
      <div id="sidebar" class="bs-sidenav card" role="complementary">
        <h3>Table of contents</h3>
        <ul>
<li><a class="reference internal" href="#">Modeling 2: Create a User Defined Model using astropy.modeling</a><ul>
<li><a class="reference internal" href="#authors">Authors</a></li>
<li><a class="reference internal" href="#learning-goals">Learning Goals</a></li>
<li><a class="reference internal" href="#keywords">Keywords</a></li>
<li><a class="reference internal" href="#summary">Summary</a><ul>
<li><a class="reference internal" href="#imports">Imports</a></li>
<li><a class="reference internal" href="#fit-an-emission-line-in-a-stellar-spectrum">Fit an emission line in a stellar spectrum</a><ul>
<li><a class="reference internal" href="#now-that-we-have-the-spectrum">Now that we have the spectrum…</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#fit-an-emission-line-with-a-gaussian-model">Fit an Emission Line with a Gaussian Model</a></li>
<li><a class="reference internal" href="#exercise">Exercise</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compound-models">Compound models</a><ul>
<li><a class="reference internal" href="#id1">Exercise</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-model">Custom model</a><ul>
<li><a class="reference internal" href="#basic-custom-model">Basic custom model</a></li>
<li><a class="reference internal" href="#id2">Exercise</a></li>
<li><a class="reference internal" href="#full-custom-model">Full custom model</a></li>
<li><a class="reference internal" href="#id3">Exercise</a></li>
<li><a class="reference internal" href="#id4">Exercise</a></li>
</ul>
</li>
</ul>

      </div>
    </div>
    

    <div class="col-md-9">
      <div class="content-padding card">
        <div>
  <a href="../_static/User-Defined-Model/User-Defined-Model.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/main?filepath=/tutorials/notebooks/User-Defined-Model/User-Defined-Model.ipynb"><button id="binder">Interactive tutorial notebook</button></a>

<div id="spacer"></div><section id="modeling-2-create-a-user-defined-model-using-astropy-modeling">
<span id="user-defined-model"></span><h1>Modeling 2: Create a User Defined Model using astropy.modeling<a class="headerlink" href="#modeling-2-create-a-user-defined-model-using-astropy-modeling" title="Permalink to this headline">¶</a></h1>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Rocio Kiman, Lia Corrales, Zé Vinícius, Stephanie T. Douglas</p>
</section>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Define a new model with <code class="docutils literal notranslate"><span class="pre">astropy</span></code></p></li>
<li><p>Identify cases were a user-defined model could be useful</p></li>
<li><p>Define models in two different ways:</p>
<ul>
<li><p>Compound models</p></li>
<li><p>Custom models</p></li>
</ul>
</li>
</ul>
<p>This tutorial assumes the student knows how to fit data using
<code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code>. This topic is covered in the <a class="reference external" href="http://www.astropy.org/astropy-tutorials/rst-tutorials/Models-Quick-Fit.html">Models-Quick-Fit
tutorial</a>.</p>
</section>
<section id="keywords">
<h2>Keywords<a class="headerlink" href="#keywords" title="Permalink to this headline">¶</a></h2>
<p>modeling, FITS, astrostatistics, matplotlib, model fitting, error bars,
scatter plots</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will learn how to define a new model in two ways:
with a compound model and with a custom model.</p>
<div class="alert alert-info"><p><strong>Note:</strong> This tutorial assumes you have already gone through <a class="reference external" href="http://www.astropy.org/astropy-tutorials/rst-tutorials/Models-Quick-Fit.html">Modeling
1</a>,
which provides an introduction to <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code></p>
</div><section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<p><span class="inputnumrole">In[1]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="kn">import</span> <span class="n">custom_model</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">Fittable1DModel</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">astroquery.sdss</span> <span class="kn">import</span> <span class="n">SDSS</span>
</pre></div>
</div>
</section>
<section id="fit-an-emission-line-in-a-stellar-spectrum">
<h3>Fit an emission line in a stellar spectrum<a class="headerlink" href="#fit-an-emission-line-in-a-stellar-spectrum" title="Permalink to this headline">¶</a></h3>
<p>M dwarfs are low mass stars (less than half of the mass of the sun).
Currently we do not understand completely the physics inside low mass
stars because they do not behave the same way higher mass stars do. For
example, they stay magnetically active longer than higher mass stars.
One way to measure magnetic activity is the height of the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">:math:`Halpha</span></code> &lt;<a class="reference external" href="https://en.wikipedia.org/wiki/H-alpha">https://en.wikipedia.org/wiki/H-alpha</a>&gt;`__ emission
line. It is located at <span class="math notranslate nohighlight">\(6563\)</span> Angstroms at the spectrum.</p>
<p>Let’s search for a spectrum of an M dwarf in the Sloan Digital Sky
Survey (SDSS). First, we are going to look for the spectrum in the <a class="reference external" href="https://dr12.sdss.org/basicSpectra">SDSS
database</a>. SDSS has a particular
way to identify the stars it observes: it uses three numbers: Plate,
Fiber and MJD (Modified Julian Date). The star we are going to use has:
* Plate: 1349 * Fiber: 216 * MJD: 52797</p>
<p>So go ahead, put this numbers in the website and click on Plot to
visualize the spectrum. Try to localize the <span class="math notranslate nohighlight">\(H\alpha\)</span> line.</p>
<p>We could download the spectrum by hand from this website, but we are
going to import it using the
<a class="reference external" href="http://astroquery.readthedocs.io/en/latest/api/astroquery.sdss.SDSSClass.html">SDSSClass</a>
from
<code class="docutils literal notranslate"><span class="pre">`astroquery.sdss</span></code> &lt;<a class="reference external" href="https://astroquery.readthedocs.io/en/latest/sdss/sdss.html#module-astroquery.sdss">https://astroquery.readthedocs.io/en/latest/sdss/sdss.html#module-astroquery.sdss</a>&gt;`__.
We can get the spectrum using the plate, fiber and mjd in the following
way:</p>
<p><span class="inputnumrole">In[2]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">SDSS</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">(</span><span class="n">plate</span><span class="o">=</span><span class="mi">1349</span><span class="p">,</span> <span class="n">fiberID</span><span class="o">=</span><span class="mi">216</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="mi">52797</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[2]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">circleci</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astroquery</span><span class="o">/</span><span class="n">sdss</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">865</span><span class="p">:</span> <span class="n">VisibleDeprecationWarning</span><span class="p">:</span> <span class="n">Reading</span> <span class="n">unicode</span> <span class="n">strings</span> <span class="n">without</span> <span class="n">specifying</span> <span class="n">the</span> <span class="n">encoding</span> <span class="n">argument</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="o">.</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">use</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">the</span> <span class="n">system</span> <span class="n">default</span><span class="o">.</span>
  <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">))</span>
</pre></div>
</div>
<section id="now-that-we-have-the-spectrum">
<h4>Now that we have the spectrum…<a class="headerlink" href="#now-that-we-have-the-spectrum" title="Permalink to this headline">¶</a></h4>
<p>One way to check what is inside the fits file <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> is the
following:</p>
<p><span class="inputnumrole">In[3]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[3]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ColDefs</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;flux&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loglam&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ivar&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;and_mask&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;J&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;or_mask&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;J&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wdisp&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;sky&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="p">;</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To plot the spectrum we need the flux as a function of wavelength
(usually called lambda or <span class="math notranslate nohighlight">\(\lambda\)</span>). Note that the wavelength is
in log scale: loglam, so we calculate <span class="math notranslate nohighlight">\(10^\lambda\)</span> to remove this
scale.</p>
<p><span class="inputnumrole">In[4]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
<span class="n">lam</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;loglam&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>To find the units for flux and wavelength, we look in
<code class="docutils literal notranslate"><span class="pre">fitsfile[0].header</span></code>.</p>
<p>FITS standard requires that the header keyword ‘bunit’ or ‘BUNIT’
contains the physical units of the array values. That’s where we’ll find
the flux units.</p>
<p><span class="inputnumrole">In[5]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Units of the flux</span>
<span class="n">units_flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;bunit&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units_flux</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[5]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1E-17</span> <span class="n">erg</span><span class="o">/</span><span class="n">cm</span><span class="o">^</span><span class="mi">2</span><span class="o">/</span><span class="n">s</span><span class="o">/</span><span class="n">Ang</span>
</pre></div>
</div>
<p>Different sources will definite wavelength information differently, so
we need to check the documentation. For example, this <a class="reference external" href="https://www.sdss.org/dr12/tutorials/quicklook/#python">SDSS
tutorial</a>
tells us what header keyword to look at.</p>
<p><span class="inputnumrole">In[6]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Units of the wavelegth</span>
<span class="n">units_wavelength_full</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WAT1_001&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units_wavelength_full</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[6]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wtype</span><span class="o">=</span><span class="n">linear</span> <span class="n">label</span><span class="o">=</span><span class="n">Wavelength</span> <span class="n">units</span><span class="o">=</span><span class="n">Angstroms</span>
</pre></div>
</div>
<p>We are going to select only the characters of the unit we care about:
Angstroms</p>
<p><span class="inputnumrole">In[7]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">units_wavelength</span> <span class="o">=</span> <span class="n">units_wavelength_full</span><span class="p">[</span><span class="mi">36</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units_wavelength</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[7]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Angstroms</span>
</pre></div>
</div>
<p>Now we are ready to plot the spectrum with all the information.</p>
<p><span class="inputnumrole">In[8]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">6300</span><span class="p">,</span><span class="mi">6700</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">6563</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units_wavelength</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units_flux</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[8]:</span></p>
<img alt="../_images/User-Defined-Model_20_0.png" src="../_images/User-Defined-Model_20_0.png" />
<p>We just plotted our spectrum! Check different ranges of wavelength to
see how the full spectrum looks like in comparison to the one we saw
before.</p>
</section>
</section>
</section>
<section id="fit-an-emission-line-with-a-gaussian-model">
<h2>Fit an Emission Line with a Gaussian Model<a class="headerlink" href="#fit-an-emission-line-with-a-gaussian-model" title="Permalink to this headline">¶</a></h2>
<p>The blue dashed line marks the <span class="math notranslate nohighlight">\(H\alpha\)</span> emission line. We can
tell this is an active star because it has a strong emission line.</p>
<p>Now, we would like to measure the height of this line. Let’s use
<code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> to fit a gaussian to the <span class="math notranslate nohighlight">\(H\alpha\)</span> line. We
are going to initialize a gaussian model at the position of the
<span class="math notranslate nohighlight">\(H\alpha\)</span> line. The idea is that the gaussian amplitude will tell
us the height of the line.</p>
<p><span class="inputnumrole">In[9]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gausian_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6563</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">gaussian_fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">gausian_model</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s plot the results.</p>
<p><span class="inputnumrole">In[10]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">gaussian_fit</span><span class="p">(</span><span class="n">lam</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">6300</span><span class="p">,</span><span class="mi">6700</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstroms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units_flux</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[10]:</span></p>
<img alt="../_images/User-Defined-Model_26_0.png" src="../_images/User-Defined-Model_26_0.png" />
<p>We can see the fit is not doing a good job. Let’s print the parameters
of this fit:</p>
<p><span class="inputnumrole">In[11]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gaussian_fit</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[11]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">Gaussian1D</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Parameters</span><span class="p">:</span>
        <span class="n">amplitude</span>             <span class="n">mean</span>             <span class="n">stddev</span>
    <span class="o">------------------</span> <span class="o">-----------------</span> <span class="o">-----------------</span>
    <span class="mf">16.750706286489784</span> <span class="mf">9456.749529382625</span> <span class="mf">2368.395705667002</span>
</pre></div>
</div>
</section>
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<p>Go back to the previous plot and try to make the fit work. Note: <strong>Do
not spend more than 10 minutes</strong> in this exercise. A couple of ideas to
try: * Is it not working because of the model we chose to fit? You can
find more models to use
<a class="reference external" href="http://docs.astropy.org/en/stable/modeling/#module-astropy.modeling.functional_models">here</a>.
* Is it not working because of the fitter we chose? * Is it not
working because of the range of data we are fitting? * Is it not
working because how we are plotting the data?</p>
</section>
</section>
<section id="compound-models">
<h1>Compound models<a class="headerlink" href="#compound-models" title="Permalink to this headline">¶</a></h1>
<p>One model is not enough to make this fit work. We need to combine a
couple of models to make a <a class="reference external" href="http://docs.astropy.org/en/stable/modeling/#compound-models">compound
model</a>
in <code class="docutils literal notranslate"><span class="pre">astropy</span></code>. The idea is that we can add, divide or multiply models
that already exist in
<a class="reference external" href="http://docs.astropy.org/en/stable/modeling/#models-and-fitting-astropy-modeling">astropy.modeling</a>
and fit the compound model to our data.</p>
<p>For our problem we are going to combine the gaussian with a polynomial
of degree 1 to account for the background spectrum close to the
<span class="math notranslate nohighlight">\(H\alpha\)</span> line. Take a look at the plot we made before to convince
yourself that this is the case.</p>
<p>Now let’s make our compound model!</p>
<p><span class="inputnumrole">In[12]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">compound_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6563</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>After this point, we fit the data in exactly the same way as before,
except we use a compound model instead of the gaussian model.</p>
<p><span class="inputnumrole">In[13]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">compound_fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">compound_model</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[14]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">compound_fit</span><span class="p">(</span><span class="n">lam</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">6300</span><span class="p">,</span><span class="mi">6700</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstroms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units_flux</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[14]:</span></p>
<img alt="../_images/User-Defined-Model_35_0.png" src="../_images/User-Defined-Model_35_0.png" />
<p>It works! Let’s take a look to the fit we just made.</p>
<p><span class="inputnumrole">In[15]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">compound_fit</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[15]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">CompoundModel</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Expression</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Components</span><span class="p">:</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">7.02089174</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">6564.13631715</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">1.97761475</span><span class="p">)</span><span class="o">&gt;</span>

    <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span><span class="o">=-</span><span class="mf">12.79335619</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.00323995</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">Parameters</span><span class="p">:</span>
       <span class="n">amplitude_0</span>          <span class="n">mean_0</span>      <span class="o">...</span>         <span class="n">c0_1</span>                <span class="n">c1_1</span>
    <span class="o">-----------------</span> <span class="o">-----------------</span> <span class="o">...</span> <span class="o">-------------------</span> <span class="o">--------------------</span>
    <span class="mf">7.020891743992038</span> <span class="mf">6564.136317149307</span> <span class="o">...</span> <span class="o">-</span><span class="mf">12.793356186323782</span> <span class="mf">0.003239952053201798</span>
</pre></div>
</div>
<p>Let’s print all the parameters in a fancy way:</p>
<p><span class="inputnumrole">In[16]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">compound_fit</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">compound_fit</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[16]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amplitude_0</span> <span class="mf">7.020891743992038</span>
<span class="n">mean_0</span> <span class="mf">6564.136317149307</span>
<span class="n">stddev_0</span> <span class="mf">1.9776147549595713</span>
<span class="n">c0_1</span> <span class="o">-</span><span class="mf">12.793356186323782</span>
<span class="n">c1_1</span> <span class="mf">0.003239952053201798</span>
</pre></div>
</div>
<p>We can see that the result includes all the fit parameters from the
gaussian (mean, std and amplitude) and the two coefficients from the
polynomial of degree 1. So now if we want to see just the amplitude:</p>
<p><span class="inputnumrole">In[17]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">compound_fit</span><span class="o">.</span><span class="n">amplitude_0</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[17]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">7.020891743992038</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Conclusions:</strong> What was the difference between the first simple
Gaussian and the compound model? The linear model that we added up to
the gaussian model allowed the base of the Gaussian fit to have a slope
and a background level. Normal Gaussians go to zero at <span class="math notranslate nohighlight">\(\pm \inf\)</span>;
this one doesn’t.</p>
<p>The mean value of the gaussian from our previous model indicates where
the <span class="math notranslate nohighlight">\(H\alpha\)</span> line is. In our fit result, we can tell that it is a
little off from <span class="math notranslate nohighlight">\(6563\)</span> Angstroms. One way to fix this is to fix
some of the parameters of the model. In <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> these are
called <a class="reference external" href="http://docs.astropy.org/en/stable/api/astropy.modeling.Parameter.html#astropy.modeling.Parameter.fixed">fixed
parameters</a>.</p>
<p><span class="inputnumrole">In[18]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">compound_model_fixed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6563</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">compound_model_fixed</span><span class="o">.</span><span class="n">mean_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Now let’s use this new model with a fixed parameter to fit the data the
same way we did before.</p>
<p><span class="inputnumrole">In[19]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">compound_fit_fixed</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">compound_model_fixed</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[20]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">compound_fit_fixed</span><span class="p">(</span><span class="n">lam</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">6300</span><span class="p">,</span><span class="mi">6700</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstroms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units_flux</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[20]:</span></p>
<img alt="../_images/User-Defined-Model_47_0.png" src="../_images/User-Defined-Model_47_0.png" />
<p><span class="inputnumrole">In[21]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">compound_fit_fixed</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[21]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">CompoundModel</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Expression</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Components</span><span class="p">:</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">1.53257471</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">6563.</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">28.57847527</span><span class="p">)</span><span class="o">&gt;</span>

    <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span><span class="o">=-</span><span class="mf">12.79103</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.00323745</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">Parameters</span><span class="p">:</span>
       <span class="n">amplitude_0</span>     <span class="n">mean_0</span> <span class="o">...</span>        <span class="n">c0_1</span>                <span class="n">c1_1</span>
    <span class="o">------------------</span> <span class="o">------</span> <span class="o">...</span> <span class="o">------------------</span> <span class="o">--------------------</span>
    <span class="mf">1.5325747099672096</span> <span class="mf">6563.0</span> <span class="o">...</span> <span class="o">-</span><span class="mf">12.79103000338307</span> <span class="mf">0.003237448628249798</span>
</pre></div>
</div>
<p>We can see in the plot that the height of the fit does not match the
<span class="math notranslate nohighlight">\(H\alpha\)</span> line height. What happend here is that we were too
strict with the mean value, so we did not get a good fit. But the mean
value is where we want it! Let’s loosen this condition a little. Another
thing we can do is to define a <a class="reference external" href="http://docs.astropy.org/en/stable/api/astropy.modeling.Parameter.html#astropy.modeling.Parameter.max">minimum and maximum
value</a>
for the mean.</p>
<p><span class="inputnumrole">In[22]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">compound_model_bounded</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6563</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">compound_model_bounded</span><span class="o">.</span><span class="n">mean_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6563</span> <span class="o">+</span> <span class="n">delta</span>
<span class="n">compound_model_bounded</span><span class="o">.</span><span class="n">mean_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">6563</span> <span class="o">-</span> <span class="n">delta</span>

<span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">compound_fit_bounded</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">compound_model_bounded</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[23]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">compound_fit_bounded</span><span class="p">(</span><span class="n">lam</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">6300</span><span class="p">,</span><span class="mi">6700</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstroms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units_flux</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[23]:</span></p>
<img alt="../_images/User-Defined-Model_51_0.png" src="../_images/User-Defined-Model_51_0.png" />
<p><span class="inputnumrole">In[24]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">compound_fit_bounded</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[24]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">CompoundModel</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Expression</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Components</span><span class="p">:</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mf">6.65730507</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="mf">6563.5</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">2.09182676</span><span class="p">)</span><span class="o">&gt;</span>

    <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c0</span><span class="o">=-</span><span class="mf">12.79336254</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.00323995</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">Parameters</span><span class="p">:</span>
       <span class="n">amplitude_0</span>    <span class="n">mean_0</span> <span class="o">...</span>         <span class="n">c0_1</span>                 <span class="n">c1_1</span>
    <span class="o">-----------------</span> <span class="o">------</span> <span class="o">...</span> <span class="o">-------------------</span> <span class="o">---------------------</span>
    <span class="mf">6.657305067136674</span> <span class="mf">6563.5</span> <span class="o">...</span> <span class="o">-</span><span class="mf">12.793362542827573</span> <span class="mf">0.0032399500254038354</span>
</pre></div>
</div>
<p>Better! By loosening the condition we added to the mean value, we got a
better fit and the mean of the gaussian is closer to where we want it.</p>
<section id="id1">
<h2>Exercise<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Modify the value of delta to change the minimum and maximum values for
the mean of the gaussian. Look for: * The better delta so the mean is
closer to the real value of the <span class="math notranslate nohighlight">\(H\alpha\)</span> line. * What is the
minimum delta for which the fit is still good according to the plot?</p>
</section>
</section>
<section id="custom-model">
<h1>Custom model<a class="headerlink" href="#custom-model" title="Permalink to this headline">¶</a></h1>
<p>What should you do if you need a model that <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code> doesn’t
provide? To solve that problem, Astropy has another tool called <a class="reference external" href="http://docs.astropy.org/en/stable/modeling/new.html">custom
model</a>. Using
this tool, we can create any model we want.</p>
<div class="line-block">
<div class="line">We will describe two ways to create a custom model: *
<a class="reference external" href="http://docs.astropy.org/en/stable/modeling/new.html#basic-custom-models">basic</a></div>
<div class="line">*
<a class="reference external" href="http://docs.astropy.org/en/stable/modeling/new.html#a-step-by-step-definition-of-a-1-d-gaussian-model">full</a></div>
</div>
<p>We use the basic custom model when we need a simple function to fit and
the full custom model when we need a more complex function. Let’s use an
example to understand each one of the custom models.</p>
<section id="basic-custom-model">
<h2>Basic custom model<a class="headerlink" href="#basic-custom-model" title="Permalink to this headline">¶</a></h2>
<p>An <strong>Exponential Model</strong> is not provided by Astropy models. Let’s see
one example of basic custom model for this case. First, let’s simulate a
dataset that follows an exponential:</p>
<p><span class="inputnumrole">In[25]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">y1_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[26]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x1</span> <span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y1_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[26]:</span></p>
<img alt="../_images/User-Defined-Model_60_0.png" src="../_images/User-Defined-Model_60_0.png" />
<p>We can define a simple custom model by specifying which parameters we
want to fit.</p>
<p><span class="inputnumrole">In[27]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_model</span>
<span class="k">def</span> <span class="nf">exponential</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    f(x)=a*exp(b*x + c)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we have one more available model to use in the same way we fit data
with <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code>.</p>
<p><span class="inputnumrole">In[28]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">exp_model</span> <span class="o">=</span> <span class="n">exponential</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">exp_fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">exp_model</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">y1_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[29]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x1</span> <span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y1_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">exp_fit</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[29]:</span></p>
<img alt="../_images/User-Defined-Model_65_0.png" src="../_images/User-Defined-Model_65_0.png" />
<p><span class="inputnumrole">In[30]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">exp_fit</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[30]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">exponential</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Parameters</span><span class="p">:</span>
            <span class="n">a</span>                  <span class="n">b</span>                   <span class="n">c</span>
    <span class="o">-----------------</span> <span class="o">-------------------</span> <span class="o">-------------------</span>
    <span class="mf">2.259449945315888</span> <span class="o">-</span><span class="mf">2.1654807299030803</span> <span class="mf">0.31906231985046585</span>
</pre></div>
</div>
<p>The fit looks good in the plot. Let’s check the parameters and the
Reduced Chi Square value, which will give us information about the
goodness of the fit.</p>
<p><span class="inputnumrole">In[31]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_reduced_chi_square</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">n_free</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    fit (array) values for the fit</span>
<span class="sd">    x,y,yerr (arrays) data</span>
<span class="sd">    N total number of points</span>
<span class="sd">    n_free number of parameters we are fitting</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">n_free</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span><span class="p">(((</span><span class="n">fit</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">yerr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[32]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">calc_reduced_chi_square</span><span class="p">(</span><span class="n">exp_fit</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y1_err</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[32]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.2814301055597643</span>
</pre></div>
</div>
<p>The Reduced Chi Square value is close to 1. Great! This means our fit is
good, and we can corroborate it by comparing the values we got for the
parameters and the ones we used to simulate the data.</p>
<p><strong>Note:</strong> Fits of non-linear parameters (like in our example) are
extremely dependent on initial conditions. Pay attention to the initial
conditions you select.</p>
</section>
<section id="id2">
<h2>Exercise<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Modify the initial conditions of the fit and check yourself the relation
between the best fit parameters and the initial conditions for the
previous example. You can check it by looking at the Reduced Chi Square
value: if it gets closer to 1 the fit is better and vice versa. To
compare the quality of the fits you can take note of the Reduced Chi
Square value you get for each initial condition.</p>
</section>
<section id="full-custom-model">
<h2>Full custom model<a class="headerlink" href="#full-custom-model" title="Permalink to this headline">¶</a></h2>
<p>What if we want to use a model from <code class="docutils literal notranslate"><span class="pre">astropy.modeling</span></code>, but with a
different set of parameters? One example is the <a class="reference external" href="http://docs.astropy.org/en/stable/api/astropy.modeling.functional_models.Sine1D.html#astropy.modeling.functional_models.Sine1D">Sine
Model</a>.
It has a very particular definition of the frequency and phase. Let’s
define a new Sine function with a full custom model. Again, first let’s
create a simulated dataset.</p>
<p><span class="inputnumrole">In[33]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x2</span><span class="o">+</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="n">d</span>
<span class="n">y2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">x2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">y2_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mf">0.3</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[34]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y2_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[34]:</span></p>
<img alt="../_images/User-Defined-Model_75_0.png" src="../_images/User-Defined-Model_75_0.png" />
<p>For the full custom model we can easily set the <strong>derivative of the
function</strong>, which is used by different
<a class="reference external" href="http://docs.astropy.org/en/stable/modeling/#id21">fitters</a>, for
example the <code class="docutils literal notranslate"><span class="pre">LevMarLSQFitter()</span></code>.</p>
<p><span class="inputnumrole">In[35]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SineNew</span><span class="p">(</span><span class="n">Fittable1DModel</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="n">d</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fit_deriv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">d_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="n">d</span>
        <span class="n">d_b</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">x</span>
        <span class="n">d_c</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
        <span class="n">d_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d_a</span><span class="p">,</span> <span class="n">d_b</span><span class="p">,</span> <span class="n">d_c</span><span class="p">,</span> <span class="n">d_d</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Note</strong> Defining default values for the fit parameters allows to define
a model as <code class="docutils literal notranslate"><span class="pre">model=SineNew()</span></code></p>
<p>We are going to fit the data with our <strong>new model</strong>. Once more, the fit
is very <strong>sensitive to the initial conditions</strong> due to the non-linearity
of the parameters.</p>
<p><span class="inputnumrole">In[36]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sine_model</span> <span class="o">=</span> <span class="n">SineNew</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
<span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
<span class="n">sine_fit</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">sine_model</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">y2_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[37]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y2_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">sine_fit</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[37]:</span></p>
<img alt="../_images/User-Defined-Model_80_0.png" src="../_images/User-Defined-Model_80_0.png" />
<p><span class="inputnumrole">In[38]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sine_fit</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[38]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Model</span><span class="p">:</span> <span class="n">SineNew</span>
<span class="n">Inputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="n">Outputs</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,)</span>
<span class="n">Model</span> <span class="nb">set</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Parameters</span><span class="p">:</span>
            <span class="n">a</span>                 <span class="n">b</span>                  <span class="n">c</span>                 <span class="n">d</span>
    <span class="o">-----------------</span> <span class="o">------------------</span> <span class="o">-----------------</span> <span class="o">-----------------</span>
    <span class="mf">3.426349686837071</span> <span class="mf">2.0100399661948902</span> <span class="mf">3.723019630141161</span> <span class="mf">0.928160199091644</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[39]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">calc_reduced_chi_square</span><span class="p">(</span><span class="n">sine_fit</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y2_err</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[39]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">6.2361425954572285</span>
</pre></div>
</div>
<p>The Reduced Chi Squared value is showing the same as the plot: this fit
could be improved. The Reduced Chi Squared is not close to 1 and the fit
is off by small phase.</p>
</section>
<section id="id3">
<h2>Exercise<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Play with the initial values for the last fit and improve the Reduced
Chi Squared value.</p>
<p><strong>Note:</strong> A fancy way of doing this would be to code a function which
iterates over different initial conditions, optimizing the Reduced Chi
Squared value. No need to do it here, but feel free to try.</p>
</section>
<section id="id4">
<h2>Exercise<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Custom models are also useful when we want to fit an <strong>unusual
function</strong> to our data. As an example, create a full custom model to fit
the following data.</p>
<p><span class="inputnumrole">In[40]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">y3</span> <span class="o">=</span> <span class="n">x3</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y3</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">x3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">y3_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[41]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">y3_err</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[41]:</span></p>
<img alt="../_images/User-Defined-Model_87_0.png" src="../_images/User-Defined-Model_87_0.png" />
<p><span class="inputnumrole">In[None]:</span></p>
<div id="spacer"></div>

<a href="../_static/User-Defined-Model/User-Defined-Model.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/main?filepath=/tutorials/notebooks/User-Defined-Model/User-Defined-Model.ipynb"><button id="binder">Interactive tutorial notebook</button></a></section>
</section>

</div>
      </div>
      
    </div>
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    &copy; Copyright Astropy.
    </p>
  </div>
</footer>
  </body>
</html>