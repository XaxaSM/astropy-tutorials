<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="filterTutorials, filterUnits, filterRadioAstronomy, filterDataCubes, filterMatplotlib" name="keywords" />
<meta content="filterTutorials," name="keywords" />

    <title>Using Astropy Quantities and Units for astrophysical calculations &#8212; astropy-tutorials v3.0.dev</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap_sandstone.css" />
    <link rel="stylesheet" type="text/css" href="../_static/astropy.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <script src="../_static/searchtools.js"></script>
    <script src="https://use.fontawesome.com/3168e95f94.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="shortcut icon" href="../_static/astropy_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript">
    jQuery(function() { Search.loadIndex("../searchindex.js"); });
  </script>
  
  <script type="text/javascript" id="searchindexloader"></script>
   

  </head><body>


<nav class="navbar navbar-expand-lg bg-navbar">
  <a class="navbar-brand" href="/" style="padding: 0px 5px;">
    <img src="../../_static/astropy_logo.png" onerror="this.onerror=null;this.src='../_static/astropy_logo.png';" style="height: 38px;">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarColor01">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item active">
        <a class="nav-link" href="http://www.astropy.org"/>Astropy<span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Modules</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0" action="../search.html" method="get">
      <div class="input-group-prepend">
          <button class="input-group-text" style="padding: 0.7rem"><i class="fa fa-search fa-fw"></i></button>
      </div>
      <input class="form-control mr-sm-3" name="q" type="text" placeholder="Search the universe" />
    </form>
  </div>
</nav>


<div class="container">
  <div class="row">

    
    
    

    
    <div class="col-md-3">
      <div id="sidebar" class="bs-sidenav card" role="complementary">
        <h3>Table of contents</h3>
        <ul>
<li><a class="reference internal" href="#">Using Astropy Quantities and Units for astrophysical calculations</a><ul>
<li><a class="reference internal" href="#authors">Authors</a></li>
<li><a class="reference internal" href="#learning-goals">Learning Goals</a></li>
<li><a class="reference internal" href="#keywords">Keywords</a></li>
<li><a class="reference internal" href="#companion-content">Companion Content</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#preliminaries">Preliminaries</a></li>
<li><a class="reference internal" href="#galaxy-mass">1. Galaxy mass</a></li>
<li><a class="reference internal" href="#exercises">Exercises</a></li>
<li><a class="reference internal" href="#molecular-cloud-mass">2. Molecular cloud mass</a><ul>
<li><a class="reference internal" href="#setting-up-the-data-cube">Setting up the data cube</a></li>
<li><a class="reference internal" href="#measuring-the-column-density-of-co">Measuring The Column Density of CO</a></li>
<li><a class="reference internal" href="#co-to-total-mass">CO to Total Mass</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Exercises</a></li>
<li><a class="reference internal" href="#using-quantities-with-functions">3. Using Quantities with Functions</a></li>
<li><a class="reference internal" href="#exercise">Exercise</a></li>
</ul>
</li>
</ul>

      </div>
    </div>
    

    <div class="col-md-9">
      <div class="content-padding card">
        <div>
  <a href="../_static/quantities/quantities.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/quantities/quantities.ipynb"><button id="binder">Interactive tutorial notebook</button></a>

<div id="spacer"></div><section id="using-astropy-quantities-and-units-for-astrophysical-calculations">
<span id="quantities"></span><h1>Using Astropy Quantities and Units for astrophysical calculations<a class="headerlink" href="#using-astropy-quantities-and-units-for-astrophysical-calculations" title="Permalink to this headline">¶</a></h1>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Ana Bonaca, Erik Tollerud, Jonathan Foster, Lia Corrales, Kris Stern,
Stephanie T. Douglas</p>
</section>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects to estimate a hypothetical galaxy’s mass</p></li>
<li><p>Take advantage of constants in the <code class="docutils literal notranslate"><span class="pre">astropy.constants</span></code> library</p></li>
<li><p>Print formatted unit strings</p></li>
<li><p>Plot <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects with unit labels, using
<code class="docutils literal notranslate"><span class="pre">astropy.visualization.quantity_support</span></code></p></li>
<li><p>Do math with <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects</p></li>
<li><p>Convert quantities with <code class="docutils literal notranslate"><span class="pre">astropy.units</span></code></p></li>
<li><p>Convert between wavelength and energy with <code class="docutils literal notranslate"><span class="pre">astropy.units.spectral</span></code>
equivalencies</p></li>
<li><p>Use the small angle approximation with
<code class="docutils literal notranslate"><span class="pre">astropy.units.dimensionless_angles</span></code> equivalencies</p></li>
<li><p>Write functions that take <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects instead of numpy
arrays</p></li>
<li><p>Make synthetic radio observations</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects such as data cubes to facilitate a full
derivation of the total mass of a molecular cloud</p></li>
</ul>
</section>
<section id="keywords">
<h2>Keywords<a class="headerlink" href="#keywords" title="Permalink to this headline">¶</a></h2>
<p>units, radio astronomy, data cubes, matplotlib</p>
</section>
<section id="companion-content">
<h2>Companion Content<a class="headerlink" href="#companion-content" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.springer.com/gp/book/9783662053942">Tools for Radio
Astronomy</a> by Rohlfs
&amp; Wilson</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we present some examples showing how Astropy’s
<code class="docutils literal notranslate"><span class="pre">Quantity</span></code> object can make astrophysics calculations easier. The
examples include calculating the mass of a galaxy from its velocity
dispersion and determining masses of molecular clouds from CO intensity
maps. We end with an example of good practices for using quantities in
functions you might distribute to other people.</p>
<p>For an in-depth discussion of <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects, see the <a class="reference external" href="http://docs.astropy.org/en/stable/units/quantity.html">astropy
documentation
section</a>.</p>
</section>
<section id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">¶</a></h2>
<p>We start by loading standard libraries and set up plotting for ipython
notebooks.</p>
<p><span class="inputnumrole">In[1]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># You shouldn&#39;t use the `seed` function in real science code, but we use it here for example purposes.</span>
<span class="c1"># It makes the &quot;random&quot; number generator always give the same numbers wherever you run it.</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># Set up matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
<p>It’s conventional to load the Astropy <code class="docutils literal notranslate"><span class="pre">units</span></code> module as the variable
<code class="docutils literal notranslate"><span class="pre">u</span></code>, demonstrated below. This will make working with <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>
objects much easier.</p>
<p>Astropy also has a <code class="docutils literal notranslate"><span class="pre">constants</span></code> module where typical physical constants
are available. The constants are stored as objects of a subclass of
<code class="docutils literal notranslate"><span class="pre">Quantity</span></code>, so they behave just like a <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>. Here, we’ll only
need the gravitational constant <code class="docutils literal notranslate"><span class="pre">G</span></code>, Planck’s constant <code class="docutils literal notranslate"><span class="pre">h</span></code>, and
Boltzmann’s constant, <code class="docutils literal notranslate"><span class="pre">k_B</span></code>.</p>
<p><span class="inputnumrole">In[2]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="kn">import</span> <span class="n">G</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">k_B</span>
</pre></div>
</div>
<p>We will also show an example of plotting while taking advantage of the
<code class="docutils literal notranslate"><span class="pre">astropy.visualization</span></code> package, which provides support for
<code class="docutils literal notranslate"><span class="pre">Quantity</span></code> units.</p>
<p><span class="inputnumrole">In[3]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
</pre></div>
</div>
</section>
<section id="galaxy-mass">
<h2>1. Galaxy mass<a class="headerlink" href="#galaxy-mass" title="Permalink to this headline">¶</a></h2>
<p>In this first example, we will use <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects to estimate a
hypothetical galaxy’s mass, given its half-light radius and radial
velocities of stars in the galaxy.</p>
<p>Let’s assume that we measured the half-light radius of the galaxy to be
29 pc projected on the sky at the distance of the galaxy. This radius is
often called the “effective radius”, so we’ll store it as a <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>
object with the name <code class="docutils literal notranslate"><span class="pre">Reff</span></code>. The easiest way to create a <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>
object is by multiplying the value with its unit. Units are accessed as
u.“unit”, in this case u.pc.</p>
<p><span class="inputnumrole">In[4]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Reff</span> <span class="o">=</span> <span class="mi">29</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span>
</pre></div>
</div>
<p>A completely equivalent (but more verbose) way of doing the same thing
is to use the <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> object’s initializer, demonstrated below. In
general, the simpler form (above) is preferred, as it is closer to how
such a quantity would actually be written in text. The initalizer form
has more options, though, which you can learn about from the <a class="reference external" href="http://docs.astropy.org/en/stable/api/astropy.units.quantity.Quantity.html">astropy
reference documentation on
Quantity</a>.</p>
<p><span class="inputnumrole">In[5]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Reff</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
</pre></div>
</div>
<p>We can access the value and unit of a <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> using the <code class="docutils literal notranslate"><span class="pre">value</span></code>
and <code class="docutils literal notranslate"><span class="pre">unit</span></code> attributes.</p>
<p><span class="inputnumrole">In[6]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Half light radius</span>
<span class="s2">value: </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">unit: </span><span class="si">{1}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reff</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Reff</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[6]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Half</span> <span class="n">light</span> <span class="n">radius</span>
<span class="n">value</span><span class="p">:</span> <span class="mf">29.0</span>
<span class="n">unit</span><span class="p">:</span> <span class="n">pc</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">value</span></code> and <code class="docutils literal notranslate"><span class="pre">unit</span></code> attributes can also be accessed within the
print function.</p>
<p><span class="inputnumrole">In[7]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Half light radius</span>
<span class="s2">value: </span><span class="si">{0.value}</span><span class="s2"></span>
<span class="s2">unit: </span><span class="si">{0.unit}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reff</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[7]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Half</span> <span class="n">light</span> <span class="n">radius</span>
<span class="n">value</span><span class="p">:</span> <span class="mf">29.0</span>
<span class="n">unit</span><span class="p">:</span> <span class="n">pc</span>
</pre></div>
</div>
<p>Furthermore, we can convert the radius in parsecs to any other unit of
length using the <code class="docutils literal notranslate"><span class="pre">to()</span></code> method. Here, we convert it to meters.</p>
<p><span class="inputnumrole">In[8]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.3g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reff</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[8]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">8.95e+17</span> <span class="n">m</span>
</pre></div>
</div>
<p>Next, we’ll first create a synthetic dataset of radial velocity
measurements, assuming a normal distribution with a mean velocity of 206
km/s and a velocity dispersion of 4.3 km/s.</p>
<p><span class="inputnumrole">In[9]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmean</span> <span class="o">=</span> <span class="mi">206</span>
<span class="n">sigin</span> <span class="o">=</span> <span class="mf">4.3</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">vmean</span><span class="p">,</span> <span class="n">sigin</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[10]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;First 10 radial velocity measurements:</span>
<span class="si">{0}</span><span class="s2"></span>
<span class="si">{1}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[10]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">First</span> <span class="mi">10</span> <span class="n">radial</span> <span class="n">velocity</span> <span class="n">measurements</span><span class="p">:</span>
<span class="p">[</span><span class="mf">205.11975706</span> <span class="mf">208.05945635</span> <span class="mf">203.76641353</span> <span class="mf">203.61035969</span> <span class="mf">214.45285646</span>
 <span class="mf">211.99164508</span> <span class="mf">206.39950387</span> <span class="mf">207.21150846</span> <span class="mf">209.30679704</span> <span class="mf">211.35966937</span><span class="p">]</span> <span class="n">km</span> <span class="o">/</span> <span class="n">s</span>
<span class="p">[</span><span class="mf">205119.75706422</span> <span class="mf">208059.45635365</span> <span class="mf">203766.41352526</span> <span class="mf">203610.35969131</span>
 <span class="mf">214452.85646176</span> <span class="mf">211991.64508178</span> <span class="mf">206399.50387</span>    <span class="mf">207211.50845717</span>
 <span class="mf">209306.79704073</span> <span class="mf">211359.66936646</span><span class="p">]</span> <span class="n">m</span> <span class="o">/</span> <span class="n">s</span>
</pre></div>
</div>
<p>One can ocassionally run into issues when attempting to plot
<code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects with <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> libraries. It is always
possible to fix this by passing the value array (e.g., <code class="docutils literal notranslate"><span class="pre">v.value</span></code>) to
<code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> functions. However, calling the
<code class="docutils literal notranslate"><span class="pre">astropy.visualization.quantity_support()</span></code> function will change the
settings on your <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> session to better handle astropy
<code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects:</p>
<p><span class="inputnumrole">In[11]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">quantity_support</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[11]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">astropy</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">quantity_support</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">MplQuantityConverter</span> <span class="n">at</span> <span class="mh">0x7f8aab1c3c10</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Now we can plot a histogram of the velocity dataset. Note that, due to
calling <code class="docutils literal notranslate"><span class="pre">quantity_support</span></code>, the x-axis is automatically labeled with
the correct units.</p>
<p><span class="inputnumrole">In[12]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[12]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/quantities_26_1.png" src="../_images/quantities_26_1.png" />
<p>Now we can calculate the velocity dispersion of the galaxy. This
demonstrates how you can perform basic operations like subtraction and
division with <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects, and also use them in standard numpy
functions such as <code class="docutils literal notranslate"><span class="pre">mean()</span></code> and <code class="docutils literal notranslate"><span class="pre">size()</span></code>. They retain their units
through these operations just as you would expect them to.</p>
<p><span class="inputnumrole">In[13]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Velocity dispersion: </span><span class="si">{0:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[13]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Velocity</span> <span class="n">dispersion</span><span class="p">:</span> <span class="mf">4.36</span> <span class="n">km</span> <span class="o">/</span> <span class="n">s</span>
</pre></div>
</div>
<p>Note how we needed to use <code class="docutils literal notranslate"><span class="pre">numpy</span></code> square root function, because the
resulting velocity dispersion quantity is a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array. If we used
the python standard <code class="docutils literal notranslate"><span class="pre">math</span></code> library’s <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> function instead, we get
an error.</p>
<p><span class="inputnumrole">In[14]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sigma_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
<p>In general, you should only use <code class="docutils literal notranslate"><span class="pre">numpy</span></code> functions with <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>
objects, <em>not</em> the <code class="docutils literal notranslate"><span class="pre">math</span></code> equivalents, unless you are sure you
understand the consequences.</p>
<p>Now for the actual mass calculation. If a galaxy is pressure-supported
(for example, an elliptical or dwarf spheroidal galaxy), its mass within
the stellar extent can be estimated using a straightforward formula:
<span class="math notranslate nohighlight">\(M_{1/2}=4\sigma^2 R_{eff}/G\)</span>. There are caveats to the use of
this formula for science – see Wolf et al. 2010 for details. For
demonstrating <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>, you can accept that this is often good
enough. For the calculation, we can multiply the quantities together,
and <code class="docutils literal notranslate"><span class="pre">astropy</span></code> will keep track of the units.</p>
<p><span class="inputnumrole">In[15]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Reff</span><span class="o">/</span><span class="n">G</span>
<span class="n">M</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[15]:</span></p>
<div class="math notranslate nohighlight">
\[3.3084841 \times 10^{13} \; \mathrm{\frac{km^{2}\,kg\,pc}{m^{3}}}\]</div>
<p>The result is in a composite unit, so it’s not really obvious it’s a
mass. However, it can be decomposed to cancel all of the length units
(<span class="math notranslate nohighlight">\(km^2 pc/m^3\)</span>) using the <code class="docutils literal notranslate"><span class="pre">decompose()</span></code> method.</p>
<p><span class="inputnumrole">In[16]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">M</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[16]:</span></p>
<div class="math notranslate nohighlight">
\[1.0208915 \times 10^{36} \; \mathrm{kg}\]</div>
<p>We can also easily express the mass in whatever form you like – solar
masses are common in astronomy, or maybe you want the default SI and CGS
units.</p>
<p><span class="inputnumrole">In[17]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Galaxy mass</span>
<span class="s2">in solar units: </span><span class="si">{0:.3g}</span><span class="s2"></span>
<span class="s2">SI units: </span><span class="si">{1:.3g}</span><span class="s2"></span>
<span class="s2">CGS units: </span><span class="si">{2:.3g}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Msun</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">cgs</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[17]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Galaxy</span> <span class="n">mass</span>
<span class="ow">in</span> <span class="n">solar</span> <span class="n">units</span><span class="p">:</span> <span class="mf">5.13e+05</span> <span class="n">solMass</span>
<span class="n">SI</span> <span class="n">units</span><span class="p">:</span> <span class="mf">1.02e+36</span> <span class="n">kg</span>
<span class="n">CGS</span> <span class="n">units</span><span class="p">:</span> <span class="mf">1.02e+39</span> <span class="n">g</span>
</pre></div>
</div>
<p>Or, if you want the log of the mass, you can just use <code class="docutils literal notranslate"><span class="pre">np.log10</span></code> as
long as the logarithm’s argument is dimensionless.</p>
<p><span class="inputnumrole">In[18]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Msun</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[18]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">5.7104736875684186</span>
</pre></div>
</div>
<p>However, you can’t take the log of something with units, as that is not
mathematically sensible.</p>
<p><span class="inputnumrole">In[19]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[19]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UnitConversionErrorTraceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity_helper</span><span class="o">/</span><span class="n">helpers</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_converter</span><span class="p">(</span><span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">)</span>
     <span class="mi">31</span>     <span class="k">try</span><span class="p">:</span>
<span class="o">---&gt;</span> <span class="mi">32</span>         <span class="n">scale</span> <span class="o">=</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">_to</span><span class="p">(</span><span class="n">to_unit</span><span class="p">)</span>
     <span class="mi">33</span>     <span class="k">except</span> <span class="n">UnitsError</span><span class="p">:</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
    <span class="mi">950</span>         <span class="k">raise</span> <span class="n">UnitConversionError</span><span class="p">(</span>
<span class="o">--&gt;</span> <span class="mi">951</span>             <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2">&#39; is not a scaled version of &#39;</span><span class="si">{</span><span class="n">other</span><span class="si">!r}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="mi">952</span>


<span class="n">UnitConversionError</span><span class="p">:</span> <span class="s1">&#39;Unit(&quot;kg km2 pc / m3&quot;)&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">scaled</span> <span class="n">version</span> <span class="n">of</span> <span class="s1">&#39;Unit(dimensionless)&#39;</span>


<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>


<span class="n">UnitConversionErrorTraceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity_helper</span><span class="o">/</span><span class="n">helpers</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">helper_dimensionless_to_dimensionless</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="mi">146</span>     <span class="k">try</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">147</span>         <span class="k">return</span> <span class="p">([</span><span class="n">get_converter</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">dimensionless_unscaled</span><span class="p">)],</span>
    <span class="mi">148</span>                 <span class="n">dimensionless_unscaled</span><span class="p">)</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity_helper</span><span class="o">/</span><span class="n">helpers</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">get_converter</span><span class="p">(</span><span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">)</span>
     <span class="mi">34</span>         <span class="k">return</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">_apply_equivalencies</span><span class="p">(</span>
<span class="o">---&gt;</span> <span class="mi">35</span>                 <span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">,</span> <span class="n">get_current_unit_registry</span><span class="p">()</span><span class="o">.</span><span class="n">equivalencies</span><span class="p">)</span>
     <span class="mi">36</span>     <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_apply_equivalencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">887</span>             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> are not convertible&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="o">--&gt;</span> <span class="mi">888</span>                 <span class="n">unit_str</span><span class="p">,</span> <span class="n">other_str</span><span class="p">))</span>
    <span class="mi">889</span>


<span class="n">UnitConversionError</span><span class="p">:</span> <span class="s1">&#39;kg km2 pc / m3&#39;</span> <span class="p">(</span><span class="n">mass</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&#39;</span> <span class="p">(</span><span class="n">dimensionless</span><span class="p">)</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">convertible</span>


<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>


<span class="n">UnitTypeErrorTraceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">19</span><span class="o">-</span><span class="mi">1</span><span class="n">faee346a12e</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">__array_ufunc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">457</span>         <span class="c1"># consistent units between two inputs (e.g., in np.add) --</span>
    <span class="mi">458</span>         <span class="c1"># and the unit of the result (or tuple of units for nout &gt; 1).</span>
<span class="o">--&gt;</span> <span class="mi">459</span>         <span class="n">converters</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">converters_and_unit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
    <span class="mi">460</span>
    <span class="mi">461</span>         <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity_helper</span><span class="o">/</span><span class="n">converters</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">converters_and_unit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="mi">164</span>
    <span class="mi">165</span>         <span class="c1"># Determine possible conversion functions, and the result unit.</span>
<span class="o">--&gt;</span> <span class="mi">166</span>         <span class="n">converters</span><span class="p">,</span> <span class="n">result_unit</span> <span class="o">=</span> <span class="n">ufunc_helper</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">units</span><span class="p">)</span>
    <span class="mi">167</span>
    <span class="mi">168</span>         <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">converter</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">converter</span> <span class="ow">in</span> <span class="n">converters</span><span class="p">):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity_helper</span><span class="o">/</span><span class="n">helpers</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">helper_dimensionless_to_dimensionless</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="mi">150</span>         <span class="k">raise</span> <span class="n">UnitTypeError</span><span class="p">(</span><span class="s2">&quot;Can only apply &#39;</span><span class="si">{}</span><span class="s2">&#39; function to &quot;</span>
    <span class="mi">151</span>                             <span class="s2">&quot;dimensionless quantities&quot;</span>
<span class="o">--&gt;</span> <span class="mi">152</span>                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="mi">153</span>
    <span class="mi">154</span>


<span class="n">UnitTypeError</span><span class="p">:</span> <span class="n">Can</span> <span class="n">only</span> <span class="n">apply</span> <span class="s1">&#39;log10&#39;</span> <span class="n">function</span> <span class="n">to</span> <span class="n">dimensionless</span> <span class="n">quantities</span>
</pre></div>
</div>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> and Kepler’s law in the form given below to determine
the (circular) orbital speed of the Earth around the sun in km/s. No
need to look up constants or conversion factors to do this calculation –
it’s all in <code class="docutils literal notranslate"><span class="pre">astropy.units</span></code> and <code class="docutils literal notranslate"><span class="pre">astropy.constants</span></code>.</p>
<div class="math notranslate nohighlight">
\[v = \sqrt{\frac{G M_{\odot}}{r}}\]</div>
<p><span class="inputnumrole">In[None]:</span></p>
<p>There’s a much easier way to figure out the velocity of the Earth using
just two units or quantities. Do that and then compare to the Kepler’s
law answer (the easiest way is probably to compute the percentage
difference, if any).</p>
<p><span class="inputnumrole">In[None]:</span></p>
<p>(Completely optional, but a good way to convince yourself of the value
of Quantity:) Do the above calculations by hand – you can use a
calculator (or python just for its arithmatic) but look up all the
appropriate conversion factors and use paper-and-pencil approaches for
keeping track of them all. Which one took longer?</p>
<p><span class="inputnumrole">In[None]:</span></p>
</section>
<section id="molecular-cloud-mass">
<h2>2. Molecular cloud mass<a class="headerlink" href="#molecular-cloud-mass" title="Permalink to this headline">¶</a></h2>
<p>In this second example, we will demonstrate how using <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>
objects can facilitate a full derivation of the total mass of a
molecular cloud using radio observations of isotopes of Carbon Monoxide
(CO).</p>
<section id="setting-up-the-data-cube">
<h3>Setting up the data cube<a class="headerlink" href="#setting-up-the-data-cube" title="Permalink to this headline">¶</a></h3>
<p>Let’s assume that we’ve mapped the inner part of a molecular cloud in
the J=1-0 rotational transition of <span class="math notranslate nohighlight">\({\rm C}^{18}{\rm O}\)</span> and are
interested in measuring its total mass. The measurement produced a data
cube with RA and Dec as spatial coordiates and velocity as the third
axis. Each voxel in this data cube represents the brightness temperature
of the emission at that position and velocity. Furthermore, we’ll assume
that we have an independent measurement of distance to the cloud
<span class="math notranslate nohighlight">\(d=250\)</span> pc and that the excitation temperature is known and
constant throughout the cloud: <span class="math notranslate nohighlight">\(T_{ex}=25\)</span> K.</p>
<p><span class="inputnumrole">In[20]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="mi">250</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span>
<span class="n">Tex</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
</pre></div>
</div>
<p>We’ll generate a synthetic dataset, assuming the cloud follows a
Gaussian distribution in each of RA, Dec and velocity. We start by
creating a 100x100x300 numpy array, such that the first coordinate is
right ascension, the second is declination, and the third is velocity.
We use the <code class="docutils literal notranslate"><span class="pre">numpy.meshgrid</span></code> function to create data cubes for each of
the three coordinates, and then use them in the formula for a Gaussian
to generate an array with the synthetic data cube. In this cube, the
cloud is positioned at the center of the cube, with <span class="math notranslate nohighlight">\(\sigma\)</span> and
the center in each dimension shown below. Note in particular that the
<span class="math notranslate nohighlight">\(\sigma\)</span> for RA and Dec have different units from the center, but
<code class="docutils literal notranslate"><span class="pre">astropy</span></code> automatically does the relevant conversions before computing
the exponential.</p>
<p><span class="inputnumrole">In[21]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cloud&#39;s center</span>
<span class="n">cen_ra</span> <span class="o">=</span> <span class="mf">52.25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">cen_dec</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">cen_v</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="c1"># Cloud&#39;s size</span>
<span class="n">sig_ra</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span>
<span class="n">sig_dec</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span>
<span class="n">sig_v</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="c1">#1D coordinate quantities</span>
<span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mf">52.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span> <span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="c1">#this creates data cubes of size for each coordinate based on the dimensions of the other coordinates</span>
<span class="n">ra_cube</span><span class="p">,</span> <span class="n">dec_cube</span><span class="p">,</span> <span class="n">v_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="n">data_gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">ra_cube</span><span class="o">-</span><span class="n">cen_ra</span><span class="p">)</span><span class="o">/</span><span class="n">sig_ra</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">dec_cube</span><span class="o">-</span><span class="n">cen_dec</span><span class="p">)</span><span class="o">/</span><span class="n">sig_dec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">v_cube</span><span class="o">-</span><span class="n">cen_v</span><span class="p">)</span><span class="o">/</span><span class="n">sig_v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
</pre></div>
</div>
<p>The units of the exponential are dimensionless, so we multiply the data
cube by K to get brightness temperature units. Radio astronomers use a
rather odd set of units [K km/s] as of integrated intensity (that is,
summing all the emission from a line over velocity). As an aside for
experts, we’re setting up our artificial cube on the main-beam
temperature scale (T:math:<code class="xref py py-obj docutils literal notranslate"><span class="pre">_{rm</span> <span class="pre">MB}</span></code>) which is the closest we can
normally get to the actual brightness temperature of our source.</p>
<p><span class="inputnumrole">In[22]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data_gauss</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
</pre></div>
</div>
<p>We will also need to know the width of each velocity bin and the size of
each pixel, so let’s calculate that now.</p>
<p><span class="inputnumrole">In[23]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Average pixel size</span>
<span class="c1"># This is only right if dec ~ 0, because of the cos(dec) factor.</span>
<span class="n">dra</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ra</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
<span class="n">ddec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">dec</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

<span class="c1">#Average velocity bin width</span>
<span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;dra = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">ddec = </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">dv = </span><span class="si">{2}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dra</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span> <span class="n">ddec</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">),</span> <span class="n">dv</span><span class="p">))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[23]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dra</span> <span class="o">=</span> <span class="mf">18.0</span> <span class="n">arcsec</span>
<span class="n">ddec</span> <span class="o">=</span> <span class="mf">18.0</span> <span class="n">arcsec</span>
<span class="n">dv</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="n">km</span> <span class="o">/</span> <span class="n">s</span>
</pre></div>
</div>
<p>We’re interested in the integrated intensity over all of the velocity
channels, so let’s create a 2D quantity array by summing our data cube
along the velocity axis (multiplying by the velocity width of a pixel).</p>
<p><span class="inputnumrole">In[24]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">intcloud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">*</span><span class="n">dv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">intcloud</span><span class="o">.</span><span class="n">unit</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[24]:</span></p>
<div class="math notranslate nohighlight">
\[\mathrm{\frac{K\,km}{s}}\]</div>
<p>We can plot the 2D quantity using matplotlib’s imshow function, by
passing the quantity’s value. Similarly, we can set the correct extent
using the values of <span class="math notranslate nohighlight">\(x_i\)</span> and <span class="math notranslate nohighlight">\(x_f\)</span>. Finally, we can set the
colorbar label to have proper units.</p>
<p><span class="inputnumrole">In[25]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Note that we display RA in the convential way by going from max to min</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">intcloud</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
           <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
           <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
           <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Intensity (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intcloud</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;RA (deg)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Dec (deg)&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[25]:</span></p>
<img alt="../_images/quantities_63_0.png" src="../_images/quantities_63_0.png" />
</section>
<section id="measuring-the-column-density-of-co">
<h3>Measuring The Column Density of CO<a class="headerlink" href="#measuring-the-column-density-of-co" title="Permalink to this headline">¶</a></h3>
<p>In order to calculate the mass of the molecular cloud, we need to
measure its column density. A number of assumptions are required for the
following calculation; the most important are that the emission is
optically thin (typically true for <span class="math notranslate nohighlight">\({\rm C}^{18}{\rm O}\)</span>) and that
conditions of local thermodynamic equilibrium hold along the line of
sight. In the case where the temperature is large compared to the
separation in energy levels for a molecule and the source fills the main
beam of the telescope, the total column density for
<span class="math notranslate nohighlight">\({\rm C}^{13}{\rm O}\)</span> is</p>
<p><span class="math notranslate nohighlight">\(N=C \frac{\int T_B(V) dV}{1-e^{-B}}\)</span></p>
<p>where the constants <span class="math notranslate nohighlight">\(C\)</span> and <span class="math notranslate nohighlight">\(B\)</span> are given by:</p>
<p><span class="math notranslate nohighlight">\(C=3.0\times10^{14} \left(\frac{\nu}{\nu_{13}}\right)^2 \frac{A_{13}}{A} {\rm K^{-1} cm^{-2} \, km^{-1} \, s}\)</span></p>
<p><span class="math notranslate nohighlight">\(B=\frac{h\nu}{k_B T}\)</span></p>
<p>(Rohlfs &amp; Wilson <a class="reference external" href="https://www.springer.com/gp/book/9783662053942">Tools for Radio
Astronomy</a>).</p>
<p>Here we have given an expression for <span class="math notranslate nohighlight">\(C\)</span> scaled to the values for
<span class="math notranslate nohighlight">\({\rm C}^{13}{\rm O}\)</span> (<span class="math notranslate nohighlight">\(\nu_{13}\)</span> and <span class="math notranslate nohighlight">\(A_{13}\)</span>). In
order to use this relation for <span class="math notranslate nohighlight">\({\rm C}^{18}{\rm O}\)</span>, we need to
rescale the frequencies <span class="math notranslate nohighlight">\({\nu}\)</span> and Einstein coefficients
<span class="math notranslate nohighlight">\(A\)</span>. <span class="math notranslate nohighlight">\(C\)</span> is in funny mixed units, but that’s okay. We’ll
define it as a <code class="docutils literal notranslate"><span class="pre">Quantities</span></code> object and not have to worry about it.</p>
<p>First, we look up the wavelength for these emission lines and store them
as quantities.</p>
<p><span class="inputnumrole">In[26]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lambda13</span> <span class="o">=</span> <span class="mf">2.60076</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
<span class="n">lambda18</span> <span class="o">=</span> <span class="mf">2.73079</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
</pre></div>
</div>
<p>Since the wavelength and frequency of light are related using the speed
of light, we can convert between them. However, doing so just using the
<code class="docutils literal notranslate"><span class="pre">to()</span></code> method fails, as units of length and frequency are not
convertible:</p>
<p><span class="inputnumrole">In[27]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nu13</span> <span class="o">=</span> <span class="n">lambda13</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">)</span>
<span class="n">nu18</span> <span class="o">=</span> <span class="n">lambda18</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[27]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UnitConversionErrorTraceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">27</span><span class="o">-</span><span class="mf">2e9</span><span class="n">e7e5707cb</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">nu13</span> <span class="o">=</span> <span class="n">lambda13</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">)</span>
      <span class="mi">2</span> <span class="n">nu18</span> <span class="o">=</span> <span class="n">lambda18</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">)</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
    <span class="mi">696</span>             <span class="c1"># Avoid using to_value to ensure that we make a copy. We also</span>
    <span class="mi">697</span>             <span class="c1"># don&#39;t want to slow down this method (esp. the scalar case).</span>
<span class="o">--&gt;</span> <span class="mi">698</span>             <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_value</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">699</span>         <span class="k">else</span><span class="p">:</span>
    <span class="mi">700</span>             <span class="c1"># to_value only copies if necessary</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_to_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">661</span>             <span class="n">equivalencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equivalencies</span>
    <span class="mi">662</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
<span class="o">--&gt;</span> <span class="mi">663</span>                             <span class="n">equivalencies</span><span class="o">=</span><span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">664</span>
    <span class="mi">665</span>     <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">985</span>             <span class="k">return</span> <span class="n">UNITY</span>
    <span class="mi">986</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">987</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_converter</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">equivalencies</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
    <span class="mi">988</span>
    <span class="mi">989</span>     <span class="k">def</span> <span class="nf">in_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[]):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">916</span>                             <span class="k">pass</span>
    <span class="mi">917</span>
<span class="o">--&gt;</span> <span class="mi">918</span>             <span class="k">raise</span> <span class="n">exc</span>
    <span class="mi">919</span>
    <span class="mi">920</span>     <span class="k">def</span> <span class="nf">_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">902</span>         <span class="k">try</span><span class="p">:</span>
    <span class="mi">903</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_equivalencies</span><span class="p">(</span>
<span class="o">--&gt;</span> <span class="mi">904</span>                 <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_equivalencies</span><span class="p">(</span><span class="n">equivalencies</span><span class="p">))</span>
    <span class="mi">905</span>         <span class="k">except</span> <span class="n">UnitsError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="mi">906</span>             <span class="c1"># Last hope: maybe other knows how to do it?</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_apply_equivalencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">886</span>         <span class="k">raise</span> <span class="n">UnitConversionError</span><span class="p">(</span>
    <span class="mi">887</span>             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> are not convertible&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="o">--&gt;</span> <span class="mi">888</span>                 <span class="n">unit_str</span><span class="p">,</span> <span class="n">other_str</span><span class="p">))</span>
    <span class="mi">889</span>
    <span class="mi">890</span>     <span class="k">def</span> <span class="nf">_get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[]):</span>


<span class="n">UnitConversionError</span><span class="p">:</span> <span class="s1">&#39;mm&#39;</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Hz&#39;</span> <span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">convertible</span>
</pre></div>
</div>
<p>Fortunately, <code class="docutils literal notranslate"><span class="pre">astropy</span></code> comes to the rescue by providing a feature
called “unit equivalencies.” Equivalencies provide a way to convert
between two physically different units that are not normally equivalent,
but in a certain context have a one-to-one mapping. For more on
equivalencies, see the <a class="reference external" href="http://docs.astropy.org/en/stable/units/equivalencies.html">equivalencies section of astropy’s
documentation</a>.</p>
<p>In this case, calling the <code class="docutils literal notranslate"><span class="pre">astropy.units.spectral()</span></code> function provides
the equivalencies necessary to handle conversions between wavelength and
frequency. To use it, provide the equivalencies to the <code class="docutils literal notranslate"><span class="pre">equivalencies</span></code>
keyword of the <code class="docutils literal notranslate"><span class="pre">to()</span></code> call:</p>
<p><span class="inputnumrole">In[28]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nu13</span> <span class="o">=</span> <span class="n">lambda13</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
<span class="n">nu18</span> <span class="o">=</span> <span class="n">lambda18</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
</pre></div>
</div>
<p>Next, we look up Einstein coefficients (in units of s<span class="math notranslate nohighlight">\(^{-1}\)</span>),
and calculate the ratios in constant <span class="math notranslate nohighlight">\(C\)</span>. Note how the ratios of
frequency and Einstein coefficient units are dimensionless, so the unit
of <span class="math notranslate nohighlight">\(C\)</span> is unchanged.</p>
<p><span class="inputnumrole">In[29]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nu13</span> <span class="o">=</span> <span class="mf">115271096910.13396</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
<span class="n">nu18</span> <span class="o">=</span> <span class="mf">109782318669.689</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
<span class="n">A13</span> <span class="o">=</span> <span class="mf">7.4e-8</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
<span class="n">A18</span> <span class="o">=</span> <span class="mf">8.8e-8</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>

<span class="n">C</span> <span class="o">=</span> <span class="mf">3e14</span> <span class="o">*</span> <span class="p">(</span><span class="n">nu18</span><span class="o">/</span><span class="n">nu13</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">A13</span><span class="o">/</span><span class="n">A18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
<span class="n">C</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[29]:</span></p>
<div class="math notranslate nohighlight">
\[2.1792458 \times 10^{14} \; \mathrm{\frac{s}{K\,km\,cm^{2}}}\]</div>
<p>Now we move on to calculate the constant <span class="math notranslate nohighlight">\(B\)</span>. This is given by the
ratio of <span class="math notranslate nohighlight">\(\frac{h\nu}{k_B T}\)</span>, where <span class="math notranslate nohighlight">\(h\)</span> is Planck’s
constant, <span class="math notranslate nohighlight">\(k_B\)</span> is the Boltzmann’s constant, <span class="math notranslate nohighlight">\(\nu\)</span> is the
emission frequency, and <span class="math notranslate nohighlight">\(T\)</span> is the excitation temperature. The
constants were imported from <code class="docutils literal notranslate"><span class="pre">astropy.constants</span></code>, and the other two
values are already calculated, so here we just take the ratio.</p>
<p><span class="inputnumrole">In[30]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">B</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">nu18</span> <span class="o">/</span> <span class="p">(</span><span class="n">k_B</span> <span class="o">*</span> <span class="n">Tex</span><span class="p">)</span>
</pre></div>
</div>
<p>The units of <span class="math notranslate nohighlight">\(B\)</span> are Hz sec, which can be decomposed to a
dimensionless unit if you actually care about its value. Usually this is
not necessary, though. Quantities are at their best if you use them
without worrying about intermediate units, and only convert at the very
end when you want a final answer.</p>
<p><span class="inputnumrole">In[31]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">decompose</span><span class="p">()))</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[31]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.21074881298143522</span> <span class="n">Hz</span> <span class="n">s</span>
<span class="mf">0.21074881298143522</span>
</pre></div>
</div>
<p>At this point we have all the ingredients to calculate the number
density of <span class="math notranslate nohighlight">\(\rm CO\)</span> molecules in this cloud. We already integrated
(summed) over the velocity channels above to show the integrated
intensity map, but we’ll do it again here for clarity. This gives us the
column density of CO for each spatial pixel in our map. We can then
print out the peak column column density.</p>
<p><span class="inputnumrole">In[32]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NCO</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">*</span><span class="n">dv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">B</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak CO column density: &quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">NCO</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[32]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Peak</span> <span class="n">CO</span> <span class="n">column</span> <span class="n">density</span><span class="p">:</span>
</pre></div>
</div>
<div class="math notranslate nohighlight">
\[8.5782091 \times 10^{15} \; \mathrm{\frac{1}{cm^{2}}}\]</div>
</section>
<section id="co-to-total-mass">
<h3>CO to Total Mass<a class="headerlink" href="#co-to-total-mass" title="Permalink to this headline">¶</a></h3>
<p>We are using CO as a tracer for the much more numerous H<span class="math notranslate nohighlight">\(_2\)</span>,
the quantity we are actually trying to infer. Since most of the mass is
in H<span class="math notranslate nohighlight">\(_2\)</span>, we calculate its column density by multiplying the CO
column density with the (known/assumed) H<span class="math notranslate nohighlight">\(_2\)</span>/CO ratio.</p>
<p><span class="inputnumrole">In[33]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">H2_CO_ratio</span> <span class="o">=</span> <span class="mf">5.9e6</span>
<span class="n">NH2</span> <span class="o">=</span> <span class="n">NCO</span> <span class="o">*</span> <span class="n">H2_CO_ratio</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Peak H2 column density: &quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">NH2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[33]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Peak</span> <span class="n">H2</span> <span class="n">column</span> <span class="n">density</span><span class="p">:</span>
</pre></div>
</div>
<div class="math notranslate nohighlight">
\[5.0611434 \times 10^{22} \; \mathrm{\frac{1}{cm^{2}}}\]</div>
<p>That’s a peak column density of roughly 50 magnitudes of visual
extinction (assuming the conversion between N<span class="math notranslate nohighlight">\(_{\rm H_2}\)</span> and
A<span class="math notranslate nohighlight">\(_V\)</span> from Bohlin et al. 1978), which seems reasonable for a
molecular cloud.</p>
<p>We obtain the mass column density by multiplying the number column
density by the mass of an individual H<span class="math notranslate nohighlight">\(_2\)</span> molecule.</p>
<p><span class="inputnumrole">In[34]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mH2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">1.008</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Dalton</span>  <span class="c1">#aka atomic mass unit/amu</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">NH2</span> <span class="o">*</span> <span class="n">mH2</span>
</pre></div>
</div>
<p>A final step in going from the column density to mass is summing up over
the area area. If we do this in the straightforward way of length x
width of a pixel, this area is then in units of <span class="math notranslate nohighlight">\({\rm deg}^2\)</span>.</p>
<p><span class="inputnumrole">In[35]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dap</span> <span class="o">=</span> <span class="n">dra</span> <span class="o">*</span> <span class="n">ddec</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dap</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[35]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.5e-05</span> <span class="n">deg2</span>
</pre></div>
</div>
<p>Now comes an important subtlety: in the small angle approximation,
multiplying the pixel area with the square of distance yields the
cross-sectional area of the cloud that the pixel covers, in <em>physical</em>
units, rather than angular units. So it’s tempting to just multiply the
area and the square of the distance.</p>
<p><span class="inputnumrole">In[36]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">da</span> <span class="o">=</span> <span class="n">dap</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># don&#39;t actually do it this way - use the version below instead!</span>
<span class="nb">print</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[36]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.5625</span> <span class="n">deg2</span> <span class="n">pc2</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[37]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dap</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">steradian</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[37]:</span></p>
<div class="math notranslate nohighlight">
\[0.00047596472 \; \mathrm{pc^{2}}\]</div>
<p>But this is <strong>wrong</strong>, because <code class="docutils literal notranslate"><span class="pre">astropy.units</span></code> treats angles (and
solid angles) as actual physical units, while the small-angle
approximation assumes angles are dimensionless. So if you, e.g., try to
convert to a different area unit, it will fail:</p>
<p><span class="inputnumrole">In[38]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">da</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[38]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UnitConversionErrorTraceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">a7ea5a2a0bb2</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">da</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
    <span class="mi">696</span>             <span class="c1"># Avoid using to_value to ensure that we make a copy. We also</span>
    <span class="mi">697</span>             <span class="c1"># don&#39;t want to slow down this method (esp. the scalar case).</span>
<span class="o">--&gt;</span> <span class="mi">698</span>             <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_value</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">699</span>         <span class="k">else</span><span class="p">:</span>
    <span class="mi">700</span>             <span class="c1"># to_value only copies if necessary</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_to_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">661</span>             <span class="n">equivalencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equivalencies</span>
    <span class="mi">662</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
<span class="o">--&gt;</span> <span class="mi">663</span>                             <span class="n">equivalencies</span><span class="o">=</span><span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">664</span>
    <span class="mi">665</span>     <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">985</span>             <span class="k">return</span> <span class="n">UNITY</span>
    <span class="mi">986</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">987</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_converter</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">equivalencies</span><span class="p">)(</span><span class="n">value</span><span class="p">)</span>
    <span class="mi">988</span>
    <span class="mi">989</span>     <span class="k">def</span> <span class="nf">in_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[]):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">916</span>                             <span class="k">pass</span>
    <span class="mi">917</span>
<span class="o">--&gt;</span> <span class="mi">918</span>             <span class="k">raise</span> <span class="n">exc</span>
    <span class="mi">919</span>
    <span class="mi">920</span>     <span class="k">def</span> <span class="nf">_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">902</span>         <span class="k">try</span><span class="p">:</span>
    <span class="mi">903</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_equivalencies</span><span class="p">(</span>
<span class="o">--&gt;</span> <span class="mi">904</span>                 <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_equivalencies</span><span class="p">(</span><span class="n">equivalencies</span><span class="p">))</span>
    <span class="mi">905</span>         <span class="k">except</span> <span class="n">UnitsError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="mi">906</span>             <span class="c1"># Last hope: maybe other knows how to do it?</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">core</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">_apply_equivalencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="p">)</span>
    <span class="mi">886</span>         <span class="k">raise</span> <span class="n">UnitConversionError</span><span class="p">(</span>
    <span class="mi">887</span>             <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> are not convertible&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="o">--&gt;</span> <span class="mi">888</span>                 <span class="n">unit_str</span><span class="p">,</span> <span class="n">other_str</span><span class="p">))</span>
    <span class="mi">889</span>
    <span class="mi">890</span>     <span class="k">def</span> <span class="nf">_get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="p">[]):</span>


<span class="n">UnitConversionError</span><span class="p">:</span> <span class="s1">&#39;deg2 pc2&#39;</span> <span class="ow">and</span> <span class="s1">&#39;cm2&#39;</span> <span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">convertible</span>
</pre></div>
</div>
<p>The solution is to use the <code class="docutils literal notranslate"><span class="pre">dimensionless_angles</span></code> equivalency, which
allows angles to be treated as dimensionless. This makes it so that they
will automatically convert to radians and become dimensionless when a
conversion is needed.</p>
<p><span class="inputnumrole">In[39]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">da</span> <span class="o">=</span> <span class="p">(</span><span class="n">dap</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span>
<span class="n">da</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[39]:</span></p>
<div class="math notranslate nohighlight">
\[0.00047596472 \; \mathrm{pc^{2}}\]</div>
<p><span class="inputnumrole">In[40]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">da</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[40]:</span></p>
<div class="math notranslate nohighlight">
\[4.5318534 \times 10^{33} \; \mathrm{cm^{2}}\]</div>
<p>Finally, multiplying the column density with the pixel area and summing
over all the pixels gives us the cloud mass.</p>
<p><span class="inputnumrole">In[41]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">da</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">solMass</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[41]:</span></p>
<div class="math notranslate nohighlight">
\[317.64843 \; \mathrm{M_{\odot}}\]</div>
</section>
</section>
<section id="id1">
<h2>Exercises<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>The astro material was pretty heavy on that one, so let’s focus on some
associated statistics using <code class="docutils literal notranslate"><span class="pre">Quantity</span></code>’s array capabililities.
Compute the median and mean of the <code class="docutils literal notranslate"><span class="pre">data</span></code> with the <code class="docutils literal notranslate"><span class="pre">np.mean</span></code> and
<code class="docutils literal notranslate"><span class="pre">np.median</span></code> functions. Why are their values so different?</p>
<p><span class="inputnumrole">In[None]:</span></p>
<p>Similarly, compute the standard deviation and variance (if you don’t
know the relevant functions, look it up in the numpy docs or just type
np. and a code cell). Do they have the units you expect?</p>
<p><span class="inputnumrole">In[None]:</span></p>
</section>
<section id="using-quantities-with-functions">
<h2>3. Using Quantities with Functions<a class="headerlink" href="#using-quantities-with-functions" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Quantity</span></code> is also a useful tool if you plan to share some of your
code, either with collaborators or the wider community. By writing
functions that take <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects instead of raw numbers or
arrays, you can write code that is agnostic to the input unit. In this
way, you may even be able to prevent <a class="reference external" href="http://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure">the destruction of Mars
orbiters</a>.
Below, we provide a simple example.</p>
<p>Suppose you are working on an instrument, and the person funding it asks
for a function to give an analytic estimate of the response function.
You determine from some tests it’s basically a Lorentzian, but with a
different scale along the two axes. Your first thought might be to do
this:</p>
<p><span class="inputnumrole">In[42]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">response_func</span><span class="p">(</span><span class="n">xinarcsec</span><span class="p">,</span> <span class="n">yinarcsec</span><span class="p">):</span>
    <span class="n">xscale</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">yscale</span> <span class="o">=</span> <span class="mf">0.85</span>
    <span class="n">xfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">xinarcsec</span><span class="o">/</span><span class="n">xscale</span><span class="p">)</span>
    <span class="n">yfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">yinarcsec</span><span class="o">/</span><span class="n">yscale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xfactor</span> <span class="o">*</span> <span class="n">yfactor</span>
</pre></div>
</div>
<p>You meant the inputs to be in arcsec, but alas, you send that to your
collaborator and they don’t look closely and think the inputs are
instead supposed to be in arcmin. So they do:</p>
<p><span class="inputnumrole">In[43]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[43]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.19640564826700893</span>
</pre></div>
</div>
<p>And now they tell all their friends how terrible the instrument is,
because it’s supposed to have arcsecond resolution, but your function
clearly shows it can only resolve an arcmin at best. But you can solve
this by requiring they pass in <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> objects. The new function
could simply be:</p>
<p><span class="inputnumrole">In[44]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">response_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">xscale</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="n">yscale</span> <span class="o">=</span> <span class="mf">0.85</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
    <span class="n">xfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="o">/</span><span class="n">xscale</span><span class="p">)</span>
    <span class="n">yfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="o">/</span><span class="n">yscale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xfactor</span> <span class="o">*</span> <span class="n">yfactor</span>
</pre></div>
</div>
<p>And your collaborator now has to pay attention. If they just blindly put
in a number they get an error:</p>
<p><span class="inputnumrole">In[45]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[45]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UnitConversionErrorTraceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">45</span><span class="o">-</span><span class="mi">5</span><span class="n">a4a987a8177</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>


<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">44</span><span class="o">-</span><span class="n">f7171be85f1d</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="n">response_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
      <span class="mi">2</span>     <span class="n">xscale</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
      <span class="mi">3</span>     <span class="n">yscale</span> <span class="o">=</span> <span class="mf">0.85</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
<span class="o">----&gt;</span> <span class="mi">4</span>     <span class="n">xfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="o">/</span><span class="n">xscale</span><span class="p">)</span>
      <span class="mi">5</span>     <span class="n">yfactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="o">/</span><span class="n">yscale</span><span class="p">)</span>
      <span class="mi">6</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">__array_ufunc__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="mi">457</span>         <span class="c1"># consistent units between two inputs (e.g., in np.add) --</span>
    <span class="mi">458</span>         <span class="c1"># and the unit of the result (or tuple of units for nout &gt; 1).</span>
<span class="o">--&gt;</span> <span class="mi">459</span>         <span class="n">converters</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">converters_and_unit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
    <span class="mi">460</span>
    <span class="mi">461</span>         <span class="n">out</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="o">~/</span><span class="n">project</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">astropy</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="n">quantity_helper</span><span class="o">/</span><span class="n">converters</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">converters_and_unit</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="mi">187</span>                             <span class="s2">&quot;argument is not a quantity (unless the &quot;</span>
    <span class="mi">188</span>                             <span class="s2">&quot;latter is all zero/infinity/nan)&quot;</span>
<span class="o">--&gt;</span> <span class="mi">189</span>                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    <span class="mi">190</span>             <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="mi">191</span>                 <span class="c1"># _can_have_arbitrary_unit failed: arg could not be compared</span>


<span class="n">UnitConversionError</span><span class="p">:</span> <span class="n">Can</span> <span class="n">only</span> <span class="n">apply</span> <span class="s1">&#39;add&#39;</span> <span class="n">function</span> <span class="n">to</span> <span class="n">dimensionless</span> <span class="n">quantities</span> <span class="n">when</span> <span class="n">other</span> <span class="n">argument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">quantity</span> <span class="p">(</span><span class="n">unless</span> <span class="n">the</span> <span class="n">latter</span> <span class="ow">is</span> <span class="nb">all</span> <span class="n">zero</span><span class="o">/</span><span class="n">infinity</span><span class="o">/</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
<p>Which is their cue to provide the units explicitly:</p>
<p><span class="inputnumrole">In[46]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">response_func</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcmin</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[46]:</span></p>
<div class="math notranslate nohighlight">
\[0.0001724307 \; \mathrm{}\]</div>
<p>The funding agency is impressed at the resolution you achieved, and your
instrument is saved! You now go on to win the Nobel Prize due to
discoveries the instrument makes. And it was all because you used
<code class="docutils literal notranslate"><span class="pre">Quantity</span></code> as the input of code you shared.</p>
</section>
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<p>Write a function that computes the Keplerian velocity you worked out in
section 1 (using <code class="docutils literal notranslate"><span class="pre">Quantity</span></code> input and outputs, of course), but
allowing for an arbitrary mass and orbital radius. Try it with some
reasonable numbers for satellites orbiting the Earth, a moon of Jupiter,
or an extrasolar planet. Feel free to use wikipedia or similar for the
masses and distances.</p>
<p><span class="inputnumrole">In[None]:</span></p>
<div id="spacer"></div>

<a href="../_static/quantities/quantities.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/quantities/quantities.ipynb"><button id="binder">Interactive tutorial notebook</button></a></section>
</section>

</div>
      </div>
      
    </div>
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    &copy; Copyright Astropy.
    </p>
  </div>
</footer>
  </body>
</html>