<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="filterTutorials, filterModeling, filterConvolution, filterCoordinates, filterWcs, filterFits, filterRadioAstronomy, filterMatplotlib, filterColorbar" name="keywords" />
<meta content="filterTutorials," name="keywords" />

    <title>Synthetic Images from simulated data &#8212; astropy-tutorials v3.0.dev</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap_sandstone.css" />
    <link rel="stylesheet" type="text/css" href="../_static/astropy.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <script src="../_static/searchtools.js"></script>
    <script src="https://use.fontawesome.com/3168e95f94.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="shortcut icon" href="../_static/astropy_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script type="text/javascript">
    jQuery(function() { Search.loadIndex("../searchindex.js"); });
  </script>
  
  <script type="text/javascript" id="searchindexloader"></script>
   

  </head><body>


<nav class="navbar navbar-expand-lg bg-navbar">
  <a class="navbar-brand" href="/" style="padding: 0px 5px;">
    <img src="../../_static/astropy_logo.png" onerror="this.onerror=null;this.src='../_static/astropy_logo.png';" style="height: 38px;">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarColor01">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item active">
        <a class="nav-link" href="http://www.astropy.org"/>Astropy<span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Modules</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0" action="../search.html" method="get">
      <div class="input-group-prepend">
          <button class="input-group-text" style="padding: 0.7rem"><i class="fa fa-search fa-fw"></i></button>
      </div>
      <input class="form-control mr-sm-3" name="q" type="text" placeholder="Search the universe" />
    </form>
  </div>
</nav>


<div class="container">
  <div class="row">

    
    
    

    
    <div class="col-md-3">
      <div id="sidebar" class="bs-sidenav card" role="complementary">
        <h3>Table of contents</h3>
        <ul>
<li><a class="reference internal" href="#">Synthetic Images from simulated data</a><ul>
<li><a class="reference internal" href="#authors">Authors</a></li>
<li><a class="reference internal" href="#learning-goals">Learning Goals</a></li>
<li><a class="reference internal" href="#keywords">Keywords</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#load-and-examine-the-fits-file">1. Load and examine the FITS file</a></li>
<li><a class="reference internal" href="#set-up-astrometry-coordinates">2. Set up astrometry coordinates</a></li>
<li><a class="reference internal" href="#prepare-a-point-spread-function-psf">3. Prepare a Point Spread Function (PSF)</a></li>
<li><a class="reference internal" href="#a-how-to-do-this-without-astropy-kernels">3.a How to do this without astropy kernels</a></li>
<li><a class="reference internal" href="#convolve-image-with-psf">4. Convolve image with PSF</a></li>
<li><a class="reference internal" href="#convolve-stokes-q-and-u-images">5. Convolve Stokes Q and U images</a></li>
<li><a class="reference internal" href="#calculate-polarization-angle-and-fraction-for-quiver-plot">6. Calculate polarization angle and fraction for quiver plot</a></li>
<li><a class="reference internal" href="#exercise">Exercise</a><ul>
<li><a class="reference internal" href="#convert-the-units-of-the-data-from-jy-arcsec-2-to-jy-beam">Convert the units of the data from Jy/arcsec^2 to Jy/beam</a></li>
</ul>
</li>
</ul>
</li>
</ul>

      </div>
    </div>
    

    <div class="col-md-9">
      <div class="content-padding card">
        <div>
  <a href="../_static/synthetic-images/synthetic-images.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/synthetic-images/synthetic-images.ipynb"><button id="binder">Interactive tutorial notebook</button></a>

<div id="spacer"></div><section id="synthetic-images-from-simulated-data">
<span id="synthetic-images"></span><h1>Synthetic Images from simulated data<a class="headerlink" href="#synthetic-images-from-simulated-data" title="Permalink to this headline">¶</a></h1>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h2>
<p>Yi-Hao Chen, Sebastian Heinz, Kelle Cruz, Stephanie T. Douglas</p>
</section>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Assign WCS astrometry to an image using <code class="docutils literal notranslate"><span class="pre">astropy.wcs</span></code></p></li>
<li><p>Construct a PSF using <code class="docutils literal notranslate"><span class="pre">astropy.modeling.model</span></code></p></li>
<li><p>Convolve raw data with PSF using <code class="docutils literal notranslate"><span class="pre">astropy.convolution</span></code></p></li>
<li><p>Calculate polarization fraction and angle from Stokes I, Q, U data</p></li>
<li><p>Overplot quivers on the image</p></li>
</ul>
</section>
<section id="keywords">
<h2>Keywords<a class="headerlink" href="#keywords" title="Permalink to this headline">¶</a></h2>
<p>modeling, convolution, coordinates, WCS, FITS, radio astronomy,
matplotlib, colorbar</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will:</p>
<p><a class="reference external" href="#1.-Load-and-examine-the-FITS-file">1. Load and examine the FITS
file</a></p>
<p><a class="reference external" href="#2.-Set-up-astrometry-coordinates">2. Set up astrometry coordinates</a></p>
<p><a class="reference external" href="#3.-Prepare-a-Point-Spread-Function-(PSF)">3. Prepare a Point Spread Function
(PSF)</a></p>
<blockquote>
<div><p><a class="reference external" href="#3.a-How-to-do-this-without-astropy-kernels">3.a How to do this without astropy
kernels</a></p>
</div></blockquote>
<p><a class="reference external" href="#4.-Convolve-image-with-PSF">4. Convolve image with PSF</a></p>
<p><a class="reference external" href="#5.-Convolve-Stokes-Q-and-U-images">5. Convolve Stokes Q and U
images</a></p>
<p><a class="reference external" href="#6.-Calculate-polarization-angle-and-fraction-for-quiver-plot">6. Calculate polarization angle and fraction for quiver
plot</a></p>
<p><span class="inputnumrole">In[1]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian2DKernel</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.models</span> <span class="kn">import</span> <span class="n">Lorentz1D</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve_fft</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</section>
<section id="load-and-examine-the-fits-file">
<h2>1. Load and examine the FITS file<a class="headerlink" href="#load-and-examine-the-fits-file" title="Permalink to this headline">¶</a></h2>
<p>Here we begin with a 2-dimensional data that were stored in FITS format
from some simulations. We have Stokes I, Q, and U maps. We we’ll first
load a FITS file and examine the header.</p>
<p><span class="inputnumrole">In[2]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_i</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
    <span class="s1">&#39;http://data.astropy.org/tutorials/synthetic-images/synchrotron_i_lobe_0700_150MHz_sm.fits&#39;</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_i</span><span class="p">)</span>
<span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>

<span class="n">hdu</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;NN_EMISSIVITY_I_LOBE_150.0MHZ&#39;</span><span class="p">]</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[2]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filename</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">circleci</span><span class="o">/.</span><span class="n">astropy</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">url</span><span class="o">/</span><span class="mi">8</span><span class="n">da27de5aa6b0db633441e82715bedf3</span><span class="o">/</span><span class="n">contents</span>
<span class="n">No</span><span class="o">.</span>    <span class="n">Name</span>      <span class="n">Ver</span>    <span class="n">Type</span>      <span class="n">Cards</span>   <span class="n">Dimensions</span>   <span class="n">Format</span>
  <span class="mi">0</span>  <span class="n">PRIMARY</span>       <span class="mi">1</span> <span class="n">PrimaryHDU</span>       <span class="mi">4</span>   <span class="p">()</span>
  <span class="mi">1</span>  <span class="n">NN_EMISSIVITY_I_LOBE_150</span><span class="mf">.0</span><span class="n">MHZ</span>    <span class="mi">1</span> <span class="n">ImageHDU</span>        <span class="mi">23</span>   <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1452</span><span class="p">)</span>   <span class="n">float64</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XTENSION</span><span class="o">=</span> <span class="s1">&#39;IMAGE   &#39;</span>           <span class="o">/</span> <span class="n">Image</span> <span class="n">extension</span>
<span class="n">BITPIX</span>  <span class="o">=</span>                  <span class="o">-</span><span class="mi">64</span> <span class="o">/</span> <span class="n">array</span> <span class="n">data</span> <span class="nb">type</span>
<span class="n">NAXIS</span>   <span class="o">=</span>                    <span class="mi">2</span> <span class="o">/</span> <span class="n">number</span> <span class="n">of</span> <span class="n">array</span> <span class="n">dimensions</span>
<span class="n">NAXIS1</span>  <span class="o">=</span>                 <span class="mi">1024</span>
<span class="n">NAXIS2</span>  <span class="o">=</span>                 <span class="mi">1452</span>
<span class="n">PCOUNT</span>  <span class="o">=</span>                    <span class="mi">0</span> <span class="o">/</span> <span class="n">number</span> <span class="n">of</span> <span class="n">parameters</span>
<span class="n">GCOUNT</span>  <span class="o">=</span>                    <span class="mi">1</span> <span class="o">/</span> <span class="n">number</span> <span class="n">of</span> <span class="n">groups</span>
<span class="n">EXTNAME</span> <span class="o">=</span> <span class="s1">&#39;NN_EMISSIVITY_I_LOBE_150.0MHZ&#39;</span> <span class="o">/</span> <span class="n">extension</span> <span class="n">name</span>
<span class="n">BTYPE</span>   <span class="o">=</span> <span class="s1">&#39;nn_emissivity_i_lobe_150.0MHz&#39;</span>
<span class="n">BUNIT</span>   <span class="o">=</span> <span class="s1">&#39;Jy/arcsec**2&#39;</span>
<span class="n">WCSAXES</span> <span class="o">=</span>                    <span class="mi">2</span>
<span class="n">CRPIX1</span>  <span class="o">=</span>                <span class="mf">512.0</span>
<span class="n">CRPIX2</span>  <span class="o">=</span>                <span class="mf">726.0</span>
<span class="n">CDELT1</span>  <span class="o">=</span> <span class="mf">9.42382812499999E+19</span>
<span class="n">CDELT2</span>  <span class="o">=</span> <span class="mf">9.42382812499999E+19</span>
<span class="n">CUNIT1</span>  <span class="o">=</span> <span class="s1">&#39;cm      &#39;</span>
<span class="n">CUNIT2</span>  <span class="o">=</span> <span class="s1">&#39;cm      &#39;</span>
<span class="n">CTYPE1</span>  <span class="o">=</span> <span class="s1">&#39;LINEAR  &#39;</span>
<span class="n">CTYPE2</span>  <span class="o">=</span> <span class="s1">&#39;LINEAR  &#39;</span>
<span class="n">CRVAL1</span>  <span class="o">=</span>                  <span class="mf">0.0</span>
<span class="n">CRVAL2</span>  <span class="o">=</span>                  <span class="mf">0.0</span>
<span class="n">LATPOLE</span> <span class="o">=</span>                 <span class="mf">90.0</span>
<span class="n">WCSNAME</span> <span class="o">=</span> <span class="s1">&#39;yt      &#39;</span>
</pre></div>
</div>
<p>We can see this FITS file, which was created in
<a class="reference external" href="https://yt-project.org/">yt</a>, has x and y coordinate in physical
units (cm). We want to convert it into sky coordinates. Before we
proceed, let’s find out the range of the data and plot a histogram.</p>
<p><span class="inputnumrole">In[3]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1">#suppress the warnings raised by taking log10 of data with zeros</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[3]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">129.7177858088622</span>
<span class="mf">0.0</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_5_1.png" src="../_images/synthetic-images_5_1.png" />
<p>Once we know the range of the data, we can do a visualization with the
proper range (<code class="docutils literal notranslate"><span class="pre">vmin</span></code> and <code class="docutils literal notranslate"><span class="pre">vmax</span></code>).</p>
<p><span class="inputnumrole">In[4]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="c1"># We plot it in log-scale and add a small number to avoid nan values.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="mf">1E-3</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[4]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="n">at</span> <span class="mh">0x7f841d437910</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_7_1.png" src="../_images/synthetic-images_7_1.png" />
</section>
<section id="set-up-astrometry-coordinates">
<h2>2. Set up astrometry coordinates<a class="headerlink" href="#set-up-astrometry-coordinates" title="Permalink to this headline">¶</a></h2>
<p>From the header, we know that the x and y axes are in centimeter.
However, in an observation we usually have RA and Dec. To convert
physical units to sky coordinates, we will need to make some assumptions
about where the object is located, i.e. the distance to the object and
the central RA and Dec.</p>
<p><span class="inputnumrole">In[5]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># distance to the object</span>
<span class="n">dist_obj</span> <span class="o">=</span> <span class="mi">200</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Mpc</span>

<span class="c1"># We have the RA in hh:mm:ss and DEC in dd:mm:ss format.</span>
<span class="c1"># We will use Skycoord to convert them into degrees later.</span>
<span class="n">ra_obj</span> <span class="o">=</span> <span class="s1">&#39;19h59m28.3566s&#39;</span>
<span class="n">dec_obj</span> <span class="o">=</span> <span class="s1">&#39;+40d44m02.096s&#39;</span>
</pre></div>
</div>
<p>Here we convert the pixel scale from cm to degree by dividing the
distance to the object.</p>
<p><span class="inputnumrole">In[6]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cdelt1</span> <span class="o">=</span> <span class="p">((</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">/</span><span class="n">dist_obj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cm&#39;</span><span class="p">))</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
<span class="n">cdelt2</span> <span class="o">=</span> <span class="p">((</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">/</span><span class="n">dist_obj</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cm&#39;</span><span class="p">))</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[6]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">8.74922223983974e-06</span> <span class="n">deg</span> <span class="mf">8.74922223983974e-06</span> <span class="n">deg</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">astropy.wcs.WCS</span></code> to prepare a FITS header.</p>
<p><span class="inputnumrole">In[7]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># reference pixel coordinate</span>
<span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># sizes of the pixel in degrees</span>
<span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">cdelt1</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">cdelt2</span><span class="o">.</span><span class="n">base</span><span class="p">]</span>

<span class="c1"># converting ra and dec into degrees</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_obj</span><span class="p">,</span> <span class="n">dec_obj</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span><span class="p">]</span>

<span class="c1"># the units of the axes are in degrees</span>
<span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now we can convert the WCS coordinate into header and update the hdu.</p>
<p><span class="inputnumrole">In[8]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wcs_header</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s take a look at the header. <code class="docutils literal notranslate"><span class="pre">CDELT1</span></code>, <code class="docutils literal notranslate"><span class="pre">CDELT2</span></code>, <code class="docutils literal notranslate"><span class="pre">CUNIT1</span></code>,
<code class="docutils literal notranslate"><span class="pre">CUNIT2</span></code>, <code class="docutils literal notranslate"><span class="pre">CRVAL1</span></code>, and <code class="docutils literal notranslate"><span class="pre">CRVAL2</span></code> are in sky coordinates now.</p>
<p><span class="inputnumrole">In[9]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[9]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XTENSION</span><span class="o">=</span> <span class="s1">&#39;IMAGE   &#39;</span>           <span class="o">/</span> <span class="n">Image</span> <span class="n">extension</span>
<span class="n">BITPIX</span>  <span class="o">=</span>                  <span class="o">-</span><span class="mi">64</span> <span class="o">/</span> <span class="n">array</span> <span class="n">data</span> <span class="nb">type</span>
<span class="n">NAXIS</span>   <span class="o">=</span>                    <span class="mi">2</span> <span class="o">/</span> <span class="n">number</span> <span class="n">of</span> <span class="n">array</span> <span class="n">dimensions</span>
<span class="n">NAXIS1</span>  <span class="o">=</span>                 <span class="mi">1024</span>
<span class="n">NAXIS2</span>  <span class="o">=</span>                 <span class="mi">1452</span>
<span class="n">PCOUNT</span>  <span class="o">=</span>                    <span class="mi">0</span> <span class="o">/</span> <span class="n">number</span> <span class="n">of</span> <span class="n">parameters</span>
<span class="n">GCOUNT</span>  <span class="o">=</span>                    <span class="mi">1</span> <span class="o">/</span> <span class="n">number</span> <span class="n">of</span> <span class="n">groups</span>
<span class="n">EXTNAME</span> <span class="o">=</span> <span class="s1">&#39;NN_EMISSIVITY_I_LOBE_150.0MHZ&#39;</span> <span class="o">/</span> <span class="n">extension</span> <span class="n">name</span>
<span class="n">BTYPE</span>   <span class="o">=</span> <span class="s1">&#39;nn_emissivity_i_lobe_150.0MHz&#39;</span>
<span class="n">BUNIT</span>   <span class="o">=</span> <span class="s1">&#39;Jy/arcsec**2&#39;</span>
<span class="n">WCSAXES</span> <span class="o">=</span>                    <span class="mi">2</span> <span class="o">/</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">coordinate</span> <span class="n">axes</span>
<span class="n">CRPIX1</span>  <span class="o">=</span>                <span class="mf">726.0</span> <span class="o">/</span> <span class="n">Pixel</span> <span class="n">coordinate</span> <span class="n">of</span> <span class="n">reference</span> <span class="n">point</span>
<span class="n">CRPIX2</span>  <span class="o">=</span>                <span class="mf">512.0</span> <span class="o">/</span> <span class="n">Pixel</span> <span class="n">coordinate</span> <span class="n">of</span> <span class="n">reference</span> <span class="n">point</span>
<span class="n">CDELT1</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">8.7492222398396E-06</span> <span class="o">/</span> <span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="n">Coordinate</span> <span class="n">increment</span> <span class="n">at</span> <span class="n">reference</span> <span class="n">point</span>
<span class="n">CDELT2</span>  <span class="o">=</span> <span class="mf">8.74922223983969E-06</span> <span class="o">/</span> <span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="n">Coordinate</span> <span class="n">increment</span> <span class="n">at</span> <span class="n">reference</span> <span class="n">point</span>
<span class="n">CUNIT1</span>  <span class="o">=</span> <span class="s1">&#39;deg     &#39;</span>           <span class="o">/</span> <span class="n">Units</span> <span class="n">of</span> <span class="n">coordinate</span> <span class="n">increment</span> <span class="ow">and</span> <span class="n">value</span>
<span class="n">CUNIT2</span>  <span class="o">=</span> <span class="s1">&#39;deg     &#39;</span>           <span class="o">/</span> <span class="n">Units</span> <span class="n">of</span> <span class="n">coordinate</span> <span class="n">increment</span> <span class="ow">and</span> <span class="n">value</span>
<span class="n">CTYPE1</span>  <span class="o">=</span> <span class="s1">&#39;LINEAR  &#39;</span>
<span class="n">CTYPE2</span>  <span class="o">=</span> <span class="s1">&#39;LINEAR  &#39;</span>
<span class="n">CRVAL1</span>  <span class="o">=</span>          <span class="mf">299.8681525</span> <span class="o">/</span> <span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="n">Coordinate</span> <span class="n">value</span> <span class="n">at</span> <span class="n">reference</span> <span class="n">point</span>
<span class="n">CRVAL2</span>  <span class="o">=</span>      <span class="mf">40.733915555556</span> <span class="o">/</span> <span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="n">Coordinate</span> <span class="n">value</span> <span class="n">at</span> <span class="n">reference</span> <span class="n">point</span>
<span class="n">LATPOLE</span> <span class="o">=</span>                 <span class="mf">90.0</span> <span class="o">/</span> <span class="p">[</span><span class="n">deg</span><span class="p">]</span> <span class="n">Native</span> <span class="n">latitude</span> <span class="n">of</span> <span class="n">celestial</span> <span class="n">pole</span>
<span class="n">WCSNAME</span> <span class="o">=</span> <span class="s1">&#39;yt      &#39;</span>
<span class="n">MJDREF</span>  <span class="o">=</span>                  <span class="mf">0.0</span> <span class="o">/</span> <span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="n">MJD</span> <span class="n">of</span> <span class="n">fiducial</span> <span class="n">time</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[10]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="mf">1e-3</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dec&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[10]:</span></p>
<img alt="../_images/synthetic-images_18_0.png" src="../_images/synthetic-images_18_0.png" />
<p>Now we have the sky coordinate for the image!</p>
</section>
<section id="prepare-a-point-spread-function-psf">
<h2>3. Prepare a Point Spread Function (PSF)<a class="headerlink" href="#prepare-a-point-spread-function-psf" title="Permalink to this headline">¶</a></h2>
<p>Simple PSFs are included in <code class="docutils literal notranslate"><span class="pre">astropy.convolution.kernel</span></code>. We’ll use
<code class="docutils literal notranslate"><span class="pre">astropy.convolution.Gaussian2DKernel</span></code> here. First we need to set the
telescope resolution. For a 2D Gaussian, we can calculate sigma in
pixels by using our pixel scale keyword <code class="docutils literal notranslate"><span class="pre">cdelt2</span></code> from above.</p>
<p><span class="inputnumrole">In[11]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># assume our telescope has 1 arcsecond resolution</span>
<span class="n">telescope_resolution</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsecond</span>

<span class="c1"># calculate the sigma in pixels.</span>
<span class="c1"># since cdelt is in degrees, we use _.to(&#39;deg&#39;)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">telescope_resolution</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">cdelt2</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[12]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># By default, the Gaussian kernel will go to 4 sigma</span>
<span class="c1"># in each direction</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

<span class="c1"># let&#39;s take a look:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[12]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="n">at</span> <span class="mh">0x7f8417132810</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_23_1.png" src="../_images/synthetic-images_23_1.png" />
</section>
<section id="a-how-to-do-this-without-astropy-kernels">
<h2>3.a How to do this without astropy kernels<a class="headerlink" href="#a-how-to-do-this-without-astropy-kernels" title="Permalink to this headline">¶</a></h2>
<p>Maybe your PSF is more complicated. Here’s an alternative way to do
this, using a 2D Lorentzian</p>
<p><span class="inputnumrole">In[13]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># set FWHM and psf grid</span>
<span class="n">telescope_resolution</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsecond</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">telescope_resolution</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">cdelt2</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">gamma</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">gamma</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">gamma</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">gamma</span><span class="p">)))</span>
<span class="n">r_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_grid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x_grid</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="n">lorentzian</span> <span class="o">=</span> <span class="n">Lorentz1D</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="p">)</span>

<span class="c1"># extrude a 2D azimuthally symmetric PSF</span>
<span class="n">lorentzian_psf</span> <span class="o">=</span> <span class="n">lorentzian</span><span class="p">(</span><span class="n">r_grid</span><span class="p">)</span>

<span class="c1"># normalization</span>
<span class="n">lorentzian_psf</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lorentzian_psf</span><span class="p">)</span>

<span class="c1"># let&#39;s take a look again:</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lorentzian_psf</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[13]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">AxesImage</span> <span class="n">at</span> <span class="mh">0x7f84170a0650</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_26_1.png" src="../_images/synthetic-images_26_1.png" />
</section>
<section id="convolve-image-with-psf">
<h2>4. Convolve image with PSF<a class="headerlink" href="#convolve-image-with-psf" title="Permalink to this headline">¶</a></h2>
<p>Here we use <code class="docutils literal notranslate"><span class="pre">astropy.convolution.convolve_fft</span></code> to convolve image. This
routine uses fourier transform for faster calculation. Especially since
our data is <span class="math notranslate nohighlight">\(2^n\)</span> sized, which makes it particually fast. Using a
fft, however, causes boundary effects. We’ll need to specify how we want
to handle the boundary. Here we choose to “wrap” the data, which means
making the data periodic.</p>
<p><span class="inputnumrole">In[14]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">convolved_image</span> <span class="o">=</span> <span class="n">convolve_fft</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;wrap&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[15]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Put a psf at the corner of the image</span>
<span class="n">delta_x_psf</span><span class="o">=</span><span class="mi">100</span> <span class="c1"># number of pixels from the edges</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">delta_x_psf</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_x_psf</span>
<span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">delta_x_psf</span><span class="p">,</span> <span class="n">delta_x_psf</span><span class="o">+</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">convolved_image</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">array</span><span class="o">/</span><span class="n">psf</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span>
</pre></div>
</div>
<p>Now let’s take a look at the convolved image.</p>
<p><span class="inputnumrole">In[16]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">i_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">convolved_image</span><span class="o">+</span><span class="mf">1e-3</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span><span class="c1">#, cmap=plt.cm.viridis)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[16]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">Colorbar</span> <span class="n">at</span> <span class="mh">0x7f8416fc2e10</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_32_1.png" src="../_images/synthetic-images_32_1.png" />
</section>
<section id="convolve-stokes-q-and-u-images">
<h2>5. Convolve Stokes Q and U images<a class="headerlink" href="#convolve-stokes-q-and-u-images" title="Permalink to this headline">¶</a></h2>
<p><span class="inputnumrole">In[17]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[17]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filename</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">circleci</span><span class="o">/.</span><span class="n">astropy</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">url</span><span class="o">/</span><span class="mi">8</span><span class="n">da27de5aa6b0db633441e82715bedf3</span><span class="o">/</span><span class="n">contents</span>
<span class="n">No</span><span class="o">.</span>    <span class="n">Name</span>      <span class="n">Ver</span>    <span class="n">Type</span>      <span class="n">Cards</span>   <span class="n">Dimensions</span>   <span class="n">Format</span>
  <span class="mi">0</span>  <span class="n">PRIMARY</span>       <span class="mi">1</span> <span class="n">PrimaryHDU</span>       <span class="mi">4</span>   <span class="p">()</span>
  <span class="mi">1</span>  <span class="n">NN_EMISSIVITY_I_LOBE_150</span><span class="mf">.0</span><span class="n">MHZ</span>    <span class="mi">1</span> <span class="n">ImageHDU</span>        <span class="mi">24</span>   <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1452</span><span class="p">)</span>   <span class="n">float64</span>
</pre></div>
</div>
<p><span class="inputnumrole">In[18]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_q</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
    <span class="s1">&#39;http://data.astropy.org/tutorials/synthetic-images/synchrotron_q_lobe_0700_150MHz_sm.fits&#39;</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_q</span><span class="p">)</span>
<span class="n">hdu_q</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;NN_EMISSIVITY_Q_LOBE_150.0MHZ&#39;</span><span class="p">]</span>

<span class="n">file_u</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
    <span class="s1">&#39;http://data.astropy.org/tutorials/synthetic-images/synchrotron_u_lobe_0700_150MHz_sm.fits&#39;</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_u</span><span class="p">)</span>
<span class="n">hdu_u</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">&#39;NN_EMISSIVITY_U_LOBE_150.0MHZ&#39;</span><span class="p">]</span>

<span class="c1"># Update the header with the wcs_header we created earlier</span>
<span class="n">hdu_q</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>
<span class="n">hdu_u</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wcs_header</span><span class="p">)</span>

<span class="c1"># Convolve the images with the the psf</span>
<span class="n">convolved_image_q</span> <span class="o">=</span> <span class="n">convolve_fft</span><span class="p">(</span><span class="n">hdu_q</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;wrap&#39;</span><span class="p">)</span>
<span class="n">convolved_image_u</span> <span class="o">=</span> <span class="n">convolve_fft</span><span class="p">(</span><span class="n">hdu_u</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;wrap&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s plot the Q and U images.</p>
<p><span class="inputnumrole">In[19]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">convolved_image_q</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span><span class="c1">#, cmap=plt.cm.viridis)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">convolved_image_u</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span><span class="c1">#, cmap=plt.cm.viridis)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[19]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colorbar</span><span class="o">.</span><span class="n">Colorbar</span> <span class="n">at</span> <span class="mh">0x7f84157ecf90</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_37_1.png" src="../_images/synthetic-images_37_1.png" />
</section>
<section id="calculate-polarization-angle-and-fraction-for-quiver-plot">
<h2>6. Calculate polarization angle and fraction for quiver plot<a class="headerlink" href="#calculate-polarization-angle-and-fraction-for-quiver-plot" title="Permalink to this headline">¶</a></h2>
<p>Note that rotating Stokes Q and I maps requires changing signs of both.
Here we assume that the Stokes q and u maps were calculated defining the
y/declination axis as vertical, such that Q is positive for polarization
vectors along the x/right-ascention axis.</p>
<p><span class="inputnumrole">In[20]:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, we plot the background image</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
<span class="n">i_plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">i_plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">convolved_image</span><span class="o">+</span><span class="mf">1e-3</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="c1"># ranges of the axis</span>
<span class="n">xx0</span><span class="p">,</span> <span class="n">xx1</span> <span class="o">=</span> <span class="n">i_plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
<span class="n">yy0</span><span class="p">,</span> <span class="n">yy1</span> <span class="o">=</span> <span class="n">i_plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

<span class="c1"># binning factor</span>
<span class="n">factor</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">66</span><span class="p">]</span>

<span class="c1"># re-binned number of points in each axis</span>
<span class="n">nx_new</span> <span class="o">=</span> <span class="n">convolved_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ny_new</span> <span class="o">=</span> <span class="n">convolved_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">factor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># These are the positions of the quivers</span>
<span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xx0</span><span class="p">,</span><span class="n">xx1</span><span class="p">,</span><span class="n">nx_new</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">yy0</span><span class="p">,</span><span class="n">yy1</span><span class="p">,</span><span class="n">ny_new</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1"># bin the data</span>
<span class="n">I_bin</span> <span class="o">=</span> <span class="n">convolved_image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx_new</span><span class="p">,</span> <span class="n">factor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ny_new</span><span class="p">,</span> <span class="n">factor</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Q_bin</span> <span class="o">=</span> <span class="n">convolved_image_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx_new</span><span class="p">,</span> <span class="n">factor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ny_new</span><span class="p">,</span> <span class="n">factor</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">U_bin</span> <span class="o">=</span> <span class="n">convolved_image_u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx_new</span><span class="p">,</span> <span class="n">factor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ny_new</span><span class="p">,</span> <span class="n">factor</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># polarization angle</span>
<span class="n">psi</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">U_bin</span><span class="p">,</span> <span class="n">Q_bin</span><span class="p">)</span>

<span class="c1"># polarization fraction</span>
<span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q_bin</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">U_bin</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">I_bin</span>

<span class="c1"># mask for low signal area</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">I_bin</span> <span class="o">&lt;</span> <span class="mf">0.1</span>

<span class="n">frac</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">psi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">pixX</span> <span class="o">=</span> <span class="n">frac</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="c1"># X-vector</span>
<span class="n">pixY</span> <span class="o">=</span> <span class="n">frac</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="c1"># Y-vector</span>

<span class="c1"># keyword arguments for quiverplots</span>
<span class="n">quiveropts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">headlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">)</span>
<span class="n">i_plot</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">pixX</span><span class="p">,</span> <span class="n">pixY</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">quiveropts</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="outputnumrole">Out[20]:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">quiver</span><span class="o">.</span><span class="n">Quiver</span> <span class="n">at</span> <span class="mh">0x7f84156ce7d0</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/synthetic-images_40_1.png" src="../_images/synthetic-images_40_1.png" />
</section>
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<section id="convert-the-units-of-the-data-from-jy-arcsec-2-to-jy-beam">
<h3>Convert the units of the data from Jy/arcsec^2 to Jy/beam<a class="headerlink" href="#convert-the-units-of-the-data-from-jy-arcsec-2-to-jy-beam" title="Permalink to this headline">¶</a></h3>
<p>The intensity of the data is given in unit of Jy/arcsec^2. Observational
data usually have the intensity unit in Jy/beam. Assuming a beam size or
take the psf we created earlier, you can convert the data into Jy/beam.</p>
<p><span class="inputnumrole">In[None]:</span></p>
<div id="spacer"></div>

<a href="../_static/synthetic-images/synthetic-images.ipynb"><button id="download">Download tutorial notebook</button></a>
<a href="https://beta.mybinder.org/v2/gh/astropy/astropy-tutorials/master?filepath=/tutorials/notebooks/synthetic-images/synthetic-images.ipynb"><button id="binder">Interactive tutorial notebook</button></a></section>
</section>
</section>

</div>
      </div>
      
    </div>
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    &copy; Copyright Astropy.
    </p>
  </div>
</footer>
  </body>
</html>